---
title: 技术驱动
date: 2020-11-21
aside: false
draft: true
---

## vue 生态相关

- generateVuex
  - 自动写入的 setMutations
  - 状态机
- vbx
- omiv 的实现
  - 111
- omi 的原理与实现
- 异步加载 table
- 海量数据的虚拟列表
  - https://www.jianshu.com/p/15cc08ec366a
  - https://juejin.im/post/5ae17a386fb9a07abc299cdd
- 图片懒加载原理

## 性能优化

- 懒加载
  - 路由
  - 图片
  - 区块，请求 （与图片类似）
- code split
  - 按需加载
  - ant d 的 icon 拆分

## CI 持续集成

- ars 平台
- qci + ars
- 蓝盾 + ars
- oci

规范： git commit, 分支, 单元测试, 发布等

## 组件库

- 腾讯云风格的业务组件库
- 包装 ant d 的业务组件库
  - 组件直接显示在文档上的模块
  - webpack 自动 loader ？
- 内部开源 TDesign

## 高管驾驶舱

- vue
- 可视化
- echart
- 通过 json 配置文件生成目录结构
- 小程序 + webview

问题：

## 行业经分平台

- 权限
- BFF 层
  - 网关
  - 业务层

## 监控平台 ？

https://blog.csdn.net/qq_34035425/article/details/84962847

sentry 部分原理： https://zhuanlan.zhihu.com/p/75577689
gif: https://mp.weixin.qq.com/s/v6R2w26qZkEilXY0mPUBCw?utm_medium=hao.caibaojian.com&utm_source=hao.caibaojian.com

一个监控关注的内容：

- performance
  - 首屏
  - dns 时间等
- js 异常
  - ???
- console.error 异常
  - 重载 console.error
- ajax 异常
  - 重写原生 ajax
- 普通信息上报
  - 普通上报携带一个 type

如何上报：

- img 标签
- axios 发送请求
- 页面关闭丢数据的问题， 有一个新的 api

特别之处：

- 实现小程序的打点上报
  - 首屏 两个周期时间
- wx.request 与 img 标签

### 关于时间计算

html5 新增的接口 performance

#### 白屏时间

## 门户

- 微前端 ？

## 问题

## cdata

- 平台整个工作链路
- 介绍高管驾驶舱

### 前端开发、发布流程

1. 用组里老的脚手架工具，或者 vue-cli@3 创建一个架子，加上测试的路由，引入依赖库，加入 oci 的配置文件等
2.

### Node

1. bff
2. 一些工具类的库
   1. 举个例子就是有些逻辑在前端做也可以，在后台做也可以，把数据吐回来的时候的清洗和处理，抽成 npm 包
3. 工具类的内部网站

### OTeam

#### Tdesign 组件库

说明白 table

#### 前端监控

背景是什么，为什么要做，期望的成果如何，现在做到什么阶段了，遇到过什么问题？

performance.timing.navigationStart 表示一个开始时间。
白屏时间的计算，是从开始加载到底部的 script 标签都执行结束之后的整个过程。
用户可操作性时间，是 DOMContentLoaded 事件执行结束之后。
下载总时间： onload 事件执行之后

##### 指标

- js error
- console.error
- ajax
- promise err catch: unhandrejection ?
- 统计打点的时间

##### 上报方式

- img gif 有很多优点
  - 跨域
  - 不会阻塞页面
  - 所有图片中的体积最小
- axios 上报也有的
- 新 api navigator.beacon 能够在页面关闭之前在请求执行完毕，降低打点的丢失率

##### 优化

- 效率： 合并打点。 搞一个简单的数组

##### 特殊场景

1. 语义对话过程，全链路都是 200 正常，但是语义测返回的内容不符合要求，也算是异常
2. 老板打开页面的时候，需要实时监控。

### feature-flag

版本发布灰度

### vue 指令打点上报

1. PV/UV
2. 点击事件 声明式上报 （很多节点注册事件的性能问题， 如何使用代理形式 ？）
3. 主动上报 耦合进业务逻辑

曝光和打点，全部通过指令来完成，尽可能与业务逻辑进行解耦，抽成组件的形式

https://www.cnblogs.com/xumengxuan/p/10682338.html
https://www.cnblogs.com/huiwenhua/p/13368415.html

https://hughfenghen.github.io/fe/vue-directive-track.html#%E4%BC%A0%E7%BB%9F%E5%9F%8B%E7%82%B9-vs-%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%9F%8B%E7%82%B9

上报的几种分类型是：

https://www.cnblogs.com/xumengxuan/p/10682338.html

https://hughfenghen.github.io/fe/vue-directive-track.html#%E5%8F%AF%E5%8F%82%E8%80%83%E7%9A%84%E6%8C%87%E4%BB%A4%E6%BA%90%E7%A0%81

#### 问题点

binding.value 不是响应式的

### 高管驾驶舱

#### 身份权限处理

后台路由权限，通过角色映射。前端也动态插入路由，差不多相同的逻辑， 用一个 npm 模块进行处理，保证结果的统一。 使用 lerna ？

#### 移动端 ant d vue table 性能问题

出现的原因： 数据量大，滑动，大量的插槽
解决办法：阅读源码，提取一个单独的 table 移动端高性能组件。

https://www.zhihu.com/question/319837974
https://zhuanlan.zhihu.com/p/102037418

##### 在对 IE 的兼容性方面做了一些取舍，原因是什么？兼容 IE 的难点都有哪些？

微信小程序 web-view 内存溢出

v3 版本为了兼容旧版 IE，不得不做一些妥协。比如说 flex 布局不能用，我们就用 float 和 table 来搞；不能用 sticky，Table 为了实现固定列不得不额外再渲染一个 Table 达到固定列的效果。最近几年，随着 windows 系统的升级，旧版 IE 的占比已经越来越小。这也是一个契机，让我们在 v4 版本可以舍弃过于陈旧的 IE 版本，从而轻装上阵。

兼容 IE 的难点在于很多行为是非预期的，往往代码没有什么问题，但是页面渲染就是不正常。对于这种情况，就需要做不少的黑科技。比如说让组件强制刷新、使用 IE only 的 css hack 等等。此外前面提到的很多 HTML 新特性在 IE 环境下无法使用，只能自行模拟导致严重的性能损耗。

#### 影响

顶部固定，左侧从栏，都是用一个单独的 table 拼接出来的，所以导致它在 ios 在滑动的时候 会有阻尼效果, overflow-x: auto 一定程度上会出现两块 table 脱离的状况。

##### 解决办法

诉求： 手机端的 table： 固定表头 + 左侧栏
sticky 固定，长列表用用虚拟列表。 table 的渲染性能比 div 慢，也可以直接用 div 来模拟。

#### 小程序内嵌 web-view 的 crash 问题

主要原因是上面的 table 性能问题。

#### 移动网关的自定义域名映射

处理之前，需要给前端项目打两份包出来，动态插入网关 key 到 baseUrl 中去， 发布两份 dist 静态资源。

通过申请一个自定义域名，与指定的 key 建立绑定关系，那前端在打包脚本上就不需要做额外的处理，baseUrl 也不需要做特殊处理，只打包一份前端代码。缺点： 微信公众号授权域名只支持添加 2 个域名，所以对于测试环境、预发环境、正式环境 有强烈 3 个环境需求的项目，这种方式就不适合。我们的项目是建立在小程序上的，开发环境只能开发者进行访问，所以可以用一个测试域名，本地开发者工具忽略域名的检查，线上的授权域名使用预发环境 和 正式环境两个域名即可。

#### 小程序

1. 自定义的头部
2. 跳转 js sdk 强行 navigateTo

#### 小程序中打开页面缓存导致无法重定向的问题

302 301 会重定向页面，到（自动）登录的页面，登录之后再重定向会原链接，此时已经戴上了登录态。正常状态是这样。

但是在小程序中静态文件会被缓存起来，每次打开小程序、打开小程序中的 webview 不一定会重定向成功。 是因为跨域了 ？https://www.cnblogs.com/wxlevel/p/7833595.html
https://blog.csdn.net/liyantianmin/article/details/73485545
https://harttle.land/2016/12/30/cors-redirect.html#header-2

**如何进行排查的**：

1. 每天的首次进入耗时会比较大
2. 小程序可能会缓存 index.html 一开始 ci 的发布不是增量发布的。后续修改为增量发布
3. 偶现接口耗时巨大，但是业务部分的中间件耗时统计显示并不高，排查问题，可能是打点节点跟业务接口同域名导致 ？需要测试一下。打点接口不需要过移动网关

#### ci cd 的迭代历史

1. 手动 rz
2. ars 平台， 手动 build
3. qci + ars
4. 蓝盾 一开始不支持前端，界面操作
5. oci

#### vbx 使用

通过 new Vue 实例来处理处理共享数据的问题，能够直接响应式处理。 不需要引入复杂的 vuex

####  如何解决业务中沉淀组件库？

subtree 或者 submodule

#### 其他

1. 单元测试
2. ci cd

### 移动端

1. 分：多个移动端 h5 页面，业务分开，独立开发部署，业务逻辑不会互相影响，复用度不够，重复开发。
2. 合：新技术栈 vue 引入，组件库，拖拽、可视化搭建开始，建立 schema 规范，模块化渲染。时间和人力，可视化搭建部分暂缓。重用逻辑增多。
3. 分：多个业务模块分开，抽离组件库、渲染器
4. 合：可视化搭建的形态， 重复模块搭建 + 微前端形式。

### js bundle webpack

在生产环境用 cdn 替换本地的 npm 包的时候，会遇到一个问题，本地会有 lock 文件对 npm 依赖进行所版本管理，但是很多时候 cdn 引入的都是最新的线上 min 文件，造成了本地环境与线上环境变现不一致的情况。

背景： 使用 echarts 经查看本地安装的是 4.8.0，线上的 cdn 引用的是 latest 版本（近几天刚刚发布了 5.0 版本）， 通过查看 github 上的 readme 和 changelog 知道有些 api 进行了更新 TODO: ， 所以导致原来的属性配置，线条产生了变化（估计应该是默认值变了 ？）

解决办法： cdn 锁版本，跟 npm 依赖安装的包版本保持一致即可。 不过后续更新版本可能需要手动更新 cdn 的版本号。

### 移动端滑动穿透的问题

https://juejin.cn/post/6844903766982918152

### axios 取消

https://segmentfault.com/a/1190000021290514

同一个模块的同一个请求何时取消

### 耗时排查

#### 移动端偶现耗时极长的问题

1. 小程序 h5 授权问题，只能绑定两个域名，所以只能绑定一个预发环境域名，正式环境域名。 测试环境域名只能在本地的开发版小程序使用，本地开发工具忽略域名检查。
2. 公司所有内网资源外部访问，都需要经过移动网关（pc 端经过智能网关）做鉴权，登录态每天失效一次，会自动进行登录。域名是 `oa.m.tencent.com` 但是小程序上需要绑定一个 request 域名，公司内部很多小程序已经绑定了这个域名，所以没有办法再直接绑定上了，想了个办法就只能新申请了一个域名 cname 到这个域名上。（通过路径转发 ？ 可能也可以实现，再想一想）
3. 经过移动网关之后，访问内网环境的服务器，请求静态资源和接口。 接口会经过机器上的 nginx 负载均衡转发到 stke 上。 stke 是用来部署后台服务的 docker 平台。
4. 问题： 小程序中网页打开发现 loading 时间过长，偶现。 前端通过在 ajax 请求之前已经接口返回之后上报接口耗时，发现长达 30s - 1min 。 移动网关处排查也发现耗时有那么久，但是 node 日志中间件打印耗时不到 1 秒。
5. 解决：
   1. nginx 默认打印的日志不会添加耗时字段，添加字段。
   2. 移动端 whistle 代理，观察每一个请求的状态，因为直接观察 nginx 日志不好观察。
   3. whistle 上的耗时显示即为前端的体验耗时。查看 nginx 上日志打印的耗时。发现也是 30 多秒。
   4. stke 上能够查看到请求到达和返回的时间节点，差值是业务计算出的耗时，这个值是正常的。
   5. dns cname 耗时排查，gslb 上，询问运维，以及 performance 上应该也能查看 ？
   6. 移动网关处也是 30 多秒。
   7. 所以推断是 请求到 stke 上的时间有问题 ？
   8. 最终排查到是 访问链路是 vip--》clb 后端--〉TKE 集群 --》业务 pod

### 重构

背景

hc 少，有很多稍微老一点的项目，以及很多前端项目都是外包处理的。 解决方案：

1. js 改 ts
2. 加入测试用例
3. 加入 ci cd
4. 升级 vue react 的依赖
5. 抽离大量的公共 npm 包
6. 引入微前端的概念
7. 考虑 iframe 的重构
   1. 目的是为了实现页面的复用
   2. 从组件、脚手架级别实现复用
      1. 组件库
      2. 脚手架
      3. 种子项目
   3. json 生成页面和模块的方案， 直接生成代码的方案
