---
layout: CustomPages
title: 三次握手和四次挥手
date: 2020-11-21
aside: false
draft: true
---

### 三次握手和四次挥手

在开始之前，先简单说一下 TCP 连接中比较常用的五个状态：

- `SYN` 表示建立连接
- `FIN` 表示关闭连接
- `ACK` 表示响应
- `PSH` 表示 data 数据传输
- `RST` 表示连接重置

其中 ACK 是可能与 SYN , FIN 等同时使用的， 比如 SYN 和 ACK 可能同时为 1， 它表示的就是建立连接之后的响应；如果只是单个的一个 SYN，表示的只是建立连接。TCP 的几次握手就是通过这样的 ACK 表现出来的。

但是 SYN 与 FIN 不会同时为 1，因为前者表示的是建立连接，后者表示的是断开连接。RST 一般是在 FIN 之后才会出现 1 的情况，表示重新连接。一般出现 FIN 包或者 RST 包时，我们就认为客户端与服务端断开了连接；当出现 SYN 和 SYN + ACK 包时， 我们就认为客户端和服务器建立了一个连接。RSH 为 1 的情况一般只出现在 data 内容不为 0 的包中，也就是说 PSH 为 1 表示的是真正有 TCP 数据包内容被传输。

TCP 的连接建立和连接关闭，都是通过请求-响应的模式完成的。

位码是 tcp 的标志位，标识：

1. Sequence number 顺序号码
2. Acknowledge number 确认号码

握手过程中传送的包里不包含数据，三次握手完毕后，客户端与服务器才正式开始传送数据。理想状态下，TCP 连接一旦建立，在通信双方中的任何一动关闭连接之前，TCP 连接都将被一直保持下去。

#### 过程

- 第一次握手：建立连接时，客户端发送 syn 包(syn=j) 到服务器，并进入 SYN_SEND 状态，等待服务器确认。
- 第二次握手：服务器收到 syn 包，必须确认客户的 SYN（ack=j+1），同时自己也发送一个 SYN 包（syn=k），即 SYN+ACK 包，此时服务器进入 SYN-RECEIVED 状态；
- 第三次握手：客户端收到服务器的 SYN ＋ ACK 包，向服务器发送确认包 ACK(ack=k+1)，此包发送完毕，客户端和服务器进入 ESTABLISHED 状态（已建立），完成三次握手。完成三次握手，客户端与服务器开始传送数据.

完成三次握手之后，主机 A 与主机 B 就开始传输数据。

#### 为什么要进行三次握手

- 在第一次通信过程中，A 向 B 发送信息之后，B 收到信息后可以确认自己的收信能力和 A 的发信能力没有问题。
- 在第二次通信中，B 向 A 发送信息之后，A 可以确认自己的发信能力和 B 的收信能力没有问题，**但是 B 不知道自己的发信能力到底如何**，所以就需要第三次通信。
- 在第三次通信中，A 向 B 发送信息之后，B 就可以确认自己的发信能力没有问题。

两次不够，四次没必要。

#### 四次挥手

TCP 是全双工的，在断开连接时两端都需要发送 FIN 和 ACK。

- 第一次挥手：主动关闭方发送一个`FIN`，用来关闭主动方到被动关闭方的数据传送，也就是主动关闭方告诉被动关闭方：我已经不 会再给你发数据了(当然，在 fin 包之前发送出去的数据，如果没有收到对应的 ack 确认报文，主动关闭方依然会重发这些数据)，但是，此时主动关闭方还可 以接受数据。发送完毕后，客户端进入 `FIN_WAIT_1` 状态。
- 第二次挥手：被动关闭方收到`FIN`包后，发送一个`ACK`给对方，确认序号为收到序号`+1`（与`SYN`相同，一个`FIN`占用一个序号）。发送完毕后，服务器端进入 `CLOSE_WAIT` 状态，客户端接收到这个确认包之后，进入 `FIN_WAIT_2` 状态，等待服务器端关闭连接。
- 第三次挥手：被动关闭方发送一个`FIN`，用来关闭被动关闭方到主动关闭方的数据传送，也就是告诉主动关闭方，我的数据也发送完了，不会再给你发数据了。发送完毕后，服务器端进入 `LAST_ACK` 状态，等待来自客户端的最后一个 ACK。
- 第四次挥手：主动关闭方收到`FIN`后，发送一个`ACK`给被动关闭方，确认序号为收到序号+1，至此，完成四次挥手。客户端接收到来自服务器端的关闭请求，发送一个确认包，并进入 `TIME_WAIT`状态，等待可能出现的要求重传的 ACK 包。服务器端接收到这个确认包之后，关闭连接，进入 `CLOSED` 状态。客户端等待了某个固定时间（两个最大段生命周期，2MSL，2 Maximum Segment Lifetime）之后，没有收到服务器端的 ACK ，认为服务器端已经正常关闭连接，于是自己也关闭连接，进入 `CLOSED` 状态。
