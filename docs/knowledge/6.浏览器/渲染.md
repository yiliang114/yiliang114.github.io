---
title: '渲染'
date: 2020-10-25
draft: true
---

## 从输入 URL 到页面加载完成的过程

1. 在浏览器地址栏输入 URL
2. 判断是否有永久重定向(301)
   1. 如果有，直接跳转到对应 URL
3. 浏览器查看资源是否有**强缓存**，有则直接使用，如果是**协商缓存**则需要到服务器进行校验资源是否可用
4. 浏览器**解析 URL**获取协议，主机，端口，path
5. 浏览器**组装一个 HTTP（GET）请求报文**
6. **DNS 解析**，查找过程如下：
   1. 浏览器缓存
   2. 本机缓存
   3. hosts 文件
   4. 路由器缓存
   5. ISP DNS 缓存
   6. DNS 查询（递归查询 / 迭代查询）
7. **端口建立 TCP 连接**，三次握手。连接建立后**发送 HTTP 请求**
8. 服务器检查**HTTP 请求头是否包含缓存验证信息**如果验证缓存新鲜，返回**304**等对应状态码
9. 处理程序读取完整请求并准备 HTTP 响应，可能需要查询数据库等操作
10. 服务器将**响应报文通过 TCP 连接发送回浏览器**
11. 浏览器接收 HTTP 响应，然后根据情况选择**关闭 TCP 连接或者保留重用，关闭 TCP 连接的四次挥手**
12. 浏览器检查响应状态码：是否为 1XX，3XX， 4XX， 5XX，这些情况处理与 2XX 不同
13. 如果资源可缓存，**进行缓存**
14. 对响应进行**解码**（例如 gzip 压缩）
15. **解析 HTML 文档，构件 DOM 树，下载资源，构造 CSSOM 树，执行 js 脚本**，这些操作没有严格的先后顺序，以下分别解释
16. **构建 DOM 树**
17. 解析过程中遇到图片、样式表、js 文件，**启动下载**
18. 构建**CSSOM 树**
19. 根据 DOM 树和 CSSOM 树构建渲染树
20. **显示页面**（HTML 解析过程中会逐步显示页面）

## 渲染过程

1. 根据 HTML 结构生成 DOM 树
2. 根据 CSS 生成 CSSOM
3. 将 `DOM` 与 `CSSOM` 合并成一个渲染树。
4. 根据渲染树来布局，计算每个节点的位置。渲染和展示。
5. 遇到 `<script>` 时，会执行并阻塞渲染

DOM 树 和 渲染树 的区别：

- DOM 树与 HTML 标签一一对应，包括 head 和隐藏元素
- 渲染树不包括 head 和隐藏元素，每一个节点都有对应的 css 属性

## 重绘和回流

重绘：当渲染树中的元素**外观**（如：颜色）发生改变，不影响布局时，产生重绘
回流：当渲染树中的元素的**布局**（如：尺寸、位置、隐藏/状态状态）发生改变时，产生重绘回流

引起 Repaint 和 Reflow 的一些操作：

- 调整窗口大小
- 字体大小
- 样式表变动
- 元素内容变化，尤其是输入控件
- CSS 伪类激活，在用户交互过程中发生
- DOM 操作，DOM 元素增删、修改
- width, clientWidth, scrollTop 等布局宽高的计算

回流必将引起重绘，而重绘不一定会引起回流。

另外，在写代码的时候要避免回流和重绘：

一些属性的读取也会引起回流，比如 JS 获取 Layout 属性值（如：offsetLeft、scrollTop、getComputedStyle 等），也会引起回流。因为浏览器需要通过回流计算最新值。

### 如何最小化重绘(repaint)和回流(reflow)？

- 使用 `visibility` 替换`display: none` ，因为前者只会引起重绘，后者会引发回流（改变了布局）
- 需要要对 DOM 元素进行复杂的操作时，可以先隐藏(display:"none")，操作完成后再显示。避免频繁操作 DOM。创建一个 documentFragment 或 div，在它上面应用所有 DOM 操作，最后添加到文档里。设置 display:none 的元素上操作，最后显示出来。
- 需要创建多个 DOM 节点时，使用 DocumentFragment 创建完后一次性的加入 document，或使用字符串拼接方式构建好对应 HTML 后再使用 innerHTML 来修改页面
- 避免频繁读取元素几何属性（例如 scrollTop）。绝对定位具有复杂动画的元素。
- 缓存 Layout 属性值，如：var left = elem.offsetLeft; 这样，多次使用 left 只产生一次回流
- 不要使用 `table` 布局，可能很小的一个小改动会造成整个 table 的重新布局。避免用 table 布局（table 元素一旦触发回流就会导致 table 里所有的其它元素回流）
- 尽量使用 css 属性简写，如：用 border 代替 border-width, border-style, border-color
- 避免逐条更改样式。建议集中修改样式，例如操作 className。批量修改元素样式：elem.className 和 elem.style.cssText 代替 elem.style.xxx
