---
title: JS/CSS 标签加载
date: 2020-11-21
draft: true
---

### style 标签写在 body 后与 body 前有什么区别？

页面加载自上而下，需要先加载样式。
写在 body 标签后，由于浏览器以逐行方式对 HTML 文档进行解析，当解析到写在尾部的样式表（外联或写在 style 标签）会导致浏览器停止之前的渲染，等待加载且解析样式表完成之后重新渲染，在 windows 的 IE 下可能会出现 FOUC 现象（即样式失效导致的页面闪烁问题）

### 为什么 JS 要放到 body 尾部？

如果 JS 需要绑定操作 DOM，那么放在 header 中如果处理不当就不会绑定到 DOM

**JS 引擎是独立于渲染引擎存在的。**我们的 JS 代码在文档的何处插入，就在何处执行。当 HTML 解析器遇到一个 script 标签时，它会暂停渲染过程，将控制权交给 JS 引擎。JS 引擎对内联的 JS 代码会直接执行，对外部 JS 文件还要先获取到脚本、再进行执行。等 JS 引擎运行完毕，浏览器又会把控制权还给渲染引擎，继续 CSSOM 和 DOM 的构建。

浏览器之所以让 JS 阻塞其它的活动，是因为它不知道 JS 会做什么改变，担心如果不阻止后续的操作，会造成混乱。

结论：

- 如果 JS 在 header 中，浏览器会阻塞并等待 JS 加载完毕并执行
- 如果 JS 在 body 尾部，览器会进行一次提前渲染，从而提前首屏出现时间

### 为什么最好把 CSS 的`<link>`标签放在`<head></head>`之间？为什么最好把 JS 的`<script>`标签恰好放在`</body>`之前，有例外情况吗？

**把`<link>`放在`<head>`中**

这种做法可以让页面逐步呈现，这种做法可以防止呈现给用户空白的页面或没有样式的内容。

**把`<script>`标签恰好放在`</body>`之前**

脚本在下载和执行期间会阻止 HTML 解析。把`<script>`标签放在底部，保证 HTML 首先完成解析，将页面尽早呈现给用户。

### CSS 和 JS 的位置会影响页面效率，为什么？

css 在加载过程中不会影响到 DOM 树的生成，但是会影响到 Render 树的生成，进而影响到 layout，所以一般来说，style 的 link 标签需要尽量放在 head 里面，因为在解析 DOM 树的时候是自上而下的，而 css 样式又是通过异步加载的，这样的话，解析 DOM 树下的 body 节点和加载 css 样式能尽可能的并行，加快 Render 树的生成的速度。

js 脚本应该放在底部，原因在于 js 线程与 GUI 渲染线程是互斥的关系，如果 js 放在首部，当下载执行 js 的时候，会影响渲染行程绘制页面，js 的作用主要是处理交互，而交互必须得先让页面呈现才能进行，所以为了保证用户体验，尽量让页面先绘制出来。

### 异步加载 js 方法

script 标签 defer 和 async 的区别

1. 指定 async 属性
   指定 async 属性的目的是不让页面等待两个脚本下载和执行，从而异步加载页面其他内容。 为此，建议异步脚本不要在加载期间修改 DOM。
   执行顺序：让脚本在加载完可用时立即执行,异步脚本一定会在页面的 load 事件前执行，但可能会在 DOMContentLoaded 事件触发之前或之 后执行。

```html
<!DOCTYPE html>
<html>
  <head>
    <title>Example HTML Page</title>
    <script type="text/javascript" async src="example1.js"></script>
    <script type="text/javascript" async src="example2.js"></script>
  </head>
  <body>
    <!-- 这里放内容 -->
  </body>
</html>
```

2. defer 属性
   执行顺序：在 dom 加载完毕后执行，defer 脚本的执行会在 window.onload 之前，其他没有添加 defer 属性的 script 标签之后

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <title></title>
    <meta charset="UTF-8" />
  </head>
  <script>
    window.onload = function() {
      console.log('window.onload');
    };
  </script>
  <script src="js/defer.js" defer></script>
  <script>
    console.log('normal');
  </script>
  <body></body>
</html>
```

3. 利用 XHR 异步加载 js 内容并执行

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <title></title>
    <meta charset="UTF-8" />
  </head>
  <script>
    var xhr = new XMLHttpRequest();
    xhr.open('get', 'js/defer.js', true);
    xhr.send();
    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4 && xhr.status == 200) {
        eval(xhr.responseText);
      }
    };
  </script>
  <body></body>
</html>
```

4. 动态创建 script 标签

```js
var script = document.createElement('script');
script.src = 'js/test.js';
document.head.appendChild(script);
```

### 请描述`<script>`、`<script async>`和`<script defer>`的区别。

- `<script>` 浏览器会立即加载并执行指定的脚本，执行结束后，HTML 解析继续。
- `<script async>` 脚本的提取、执行的过程与 HTML 解析过程并行，脚本执行完毕可能在 HTML 解析完毕之前。当脚本与页面上其他脚本独立时，可以使用`async`，比如用作页面统计分析。
- `<script defer>` 延迟执行。载入 JavaScript 文件时不阻塞 HTML 的解析，执行阶段被放到 HTML 标签解析完成之后；在加载多个 JS 脚本的时候，async 是无顺序的加载，而 defer 是有顺序的加载

### 如何避免 js 阻塞渲染?

### img 加载会影响渲染吗
