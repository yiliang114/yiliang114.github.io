---
title: TBP
date: 2020-11-21
draft: true
---

## TBP 背景

腾讯智能对话平台底层的对话模型来自微信，将微信对话系统核心技术通过公有云接入的形式，为开发者提供开发平台和机器人中间件能力，实现便捷、高效、低成本构建人机对话应用。

机器人中间件： 任务型机器人、问答型机器人，平台内建机器人能力。
应用接入： 提供多渠道应用集成能力，可使开发者大幅度减少多平台开发的工作量，实现开发者轻松将其开发完成后的机器人集成到移动 App、网站、IoT 设备等多终端；并与微信公众号运营平台进行打通，支持零代码接入微信公众号。

背景：ASR + NLP + TTS。 控制台主要的功能是对于 NLP 物料输入的配置，另外是对能力输出的配置，例如公众号、小程序等。

- 语义配置平台
- 小程序、h5（一键对外接入对话机器人）、公众号

公众号授权的过程： 点击授权， 带上 RobotId, 进行微信公众号绑定，再通过微信 code2Key 换到 accessToken 作身份鉴权用。

### 小程序、公众号

1.  解释 appid 的获取与兑换
2.  如何对接口做一层安全校验加密（前端如何来说公钥才能不被破解），收费等，才能防止被褥羊毛(举例说明有道翻译 api)
    1. 简单描述一下腾讯云官网的云 api3.0 的意义，appid -> tinyid

### 小程序问题

#### 小程序内嵌 web-view 的 crash 问题

主要原因是上面的 table 性能问题。

#### 移动网关的自定义域名映射

处理之前，需要给前端项目打两份包出来，动态插入网关 key 到 baseUrl 中去， 发布两份 dist 静态资源。

通过申请一个自定义域名，与指定的 key 建立绑定关系，那前端在打包脚本上就不需要做额外的处理，baseUrl 也不需要做特殊处理，只打包一份前端代码。缺点： 微信公众号授权域名只支持添加 2 个域名，所以对于测试环境、预发环境、正式环境 有强烈 3 个环境需求的项目，这种方式就不适合。我们的项目是建立在小程序上的，开发环境只能开发者进行访问，所以可以用一个测试域名，本地开发者工具忽略域名的检查，线上的授权域名使用预发环境 和 正式环境两个域名即可。

#### 移动端偶现耗时极长的问题

1. 小程序 h5 授权问题，只能绑定两个域名，所以只能绑定一个预发环境域名，正式环境域名。 测试环境域名只能在本地的开发版小程序使用，本地开发工具忽略域名检查。
2. 公司所有内网资源外部访问，都需要经过移动网关（pc 端经过智能网关）做鉴权，登录态每天失效一次，会自动进行登录。域名是 `xxx.m.yyyy.com` 但是小程序上需要绑定一个 request 域名，公司内部很多小程序已经绑定了这个域名，所以没有办法再直接绑定上了，想了个办法就只能新申请了一个域名 cname 到这个域名上。（通过路径转发 ？ 可能也可以实现，再想一想）
3. 经过移动网关之后，访问内网环境的服务器，请求静态资源和接口。 接口会经过机器上的 nginx 负载均衡转发到 stke 上。 stke 是用来部署后台服务的 docker 平台。
4. 问题： 小程序中网页打开发现 loading 时间过长，偶现。 前端通过在 ajax 请求之前已经接口返回之后上报接口耗时，发现长达 30s - 1min 。 移动网关处排查也发现耗时有那么久，但是 node 日志中间件打印耗时不到 1 秒。
5. 解决：
   1. nginx 默认打印的日志不会添加耗时字段，添加字段。
   2. 移动端 whistle 代理，观察每一个请求的状态，因为直接观察 nginx 日志不好观察。
   3. whistle 上的耗时显示即为前端的体验耗时。查看 nginx 上日志打印的耗时。发现也是 30 多秒。
   4. stke 上能够查看到请求到达和返回的时间节点，差值是业务计算出的耗时，这个值是正常的。
   5. dns cname 耗时排查，gslb 上，询问运维，以及 performance 上应该也能查看。
   6. 移动网关处也是 30 多秒。
   7. 所以推断是 请求到 stke 上的时间有问题 ？
   8. 最终排查到是 访问链路是 vip--》clb 后端--〉TKE 集群 --》业务 pod

微信公众号 or 小程序 webview 内嵌 h5 授权的流程： https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html

#### 身份权限处理

后台路由权限，通过角色映射。前端也动态插入路由，差不多相同的逻辑， 用一个 npm 模块进行处理，保证结果的统一。 使用 lerna ？

#### 移动端 ant d vue table 性能问题

出现的原因： 数据量大，滑动，大量的插槽
解决办法：阅读源码，提取一个单独的 table 移动端高性能组件。

https://www.zhihu.com/question/319837974
https://zhuanlan.zhihu.com/p/102037418

##### 在对 IE 的兼容性方面做了一些取舍，原因是什么？兼容 IE 的难点都有哪些？

微信小程序 web-view 内存溢出

v3 版本为了兼容旧版 IE，不得不做一些妥协。比如说 flex 布局不能用，我们就用 float 和 table 来搞；不能用 sticky，Table 为了实现固定列不得不额外再渲染一个 Table 达到固定列的效果。最近几年，随着 windows 系统的升级，旧版 IE 的占比已经越来越小。这也是一个契机，让我们在 v4 版本可以舍弃过于陈旧的 IE 版本，从而轻装上阵。

兼容 IE 的难点在于很多行为是非预期的，往往代码没有什么问题，但是页面渲染就是不正常。对于这种情况，就需要做不少的黑科技。比如说让组件强制刷新、使用 IE only 的 css hack 等等。此外前面提到的很多 HTML 新特性在 IE 环境下无法使用，只能自行模拟导致严重的性能损耗。

#### 影响

顶部固定，左侧从栏，都是用一个单独的 table 拼接出来的，所以导致它在 ios 在滑动的时候 会有阻尼效果, overflow-x: auto 一定程度上会出现两块 table 脱离的状况。

##### 解决办法

诉求： 手机端的 table： 固定表头 + 左侧栏
sticky 固定，长列表用用虚拟列表。 table 的渲染性能比 div 慢，也可以直接用 div 来模拟。

#### 小程序中打开页面缓存导致无法重定向的问题

302 301 会重定向页面，到（自动）登录的页面，登录之后再重定向会原链接，此时已经戴上了登录态。正常状态是这样。

但是在小程序中静态文件会被缓存起来，每次打开小程序、打开小程序中的 webview 不一定会重定向成功。 是因为跨域了 ？https://www.cnblogs.com/wxlevel/p/7833595.html
https://blog.csdn.net/liyantianmin/article/details/73485545
https://harttle.land/2016/12/30/cors-redirect.html#header-2

**如何进行排查的**：

1. 每天的首次进入耗时会比较大
2. 小程序可能会缓存 index.html 一开始 ci 的发布不是增量发布的。后续修改为增量发布
3. 偶现接口耗时巨大，但是业务部分的中间件耗时统计显示并不高，排查问题，可能是打点节点跟业务接口同域名导致 ？需要测试一下。打点接口不需要过移动网关

#### 移动端

1. 分：多个移动端 h5 页面，业务分开，独立开发部署，业务逻辑不会互相影响，复用度不够，重复开发。
2. 合：新技术栈 vue 引入，组件库，拖拽、可视化搭建开始，建立 schema 规范，模块化渲染。时间和人力，可视化搭建部分暂缓。重用逻辑增多。
3. 分：多个业务模块分开，抽离组件库、渲染器
4. 合：可视化搭建的形态， 重复模块搭建 + 微前端形式。

### 意图配置

## TBP 控制台

1.  vue 的 input 中中文输入法的 bug， value 为空，但是一直在 input， keydown 值为 229 的解决办法
2.  输入框限频校验输入是否合法的问题，解释原理是由于 settimeout 造成的，为了适用于 promise 该如何改写，实现类似 sleep 的效果。

vue 全家桶的运营平台：说一说性能优化的点，开发模式下使用 import vue 等模块，产品模式下会再 html 文件中自动插入比较大的 js 的 cdn 文件(这里吃了一次亏，最好用自己的 cdn)，而 bundlejs 中自动将这些 js 文件打包分离出来，再通过脚本将这些 js 都上传到七牛云上去，所以基本上可以直接被访问。

### 实现的功能

1. 路由跳转前弹框。没有 vue router 的守卫函数的情况下如何处理？seajs 的路由处理方式。
2. vue 项目开发环境和生产环境的 bundle js 优化，以及如何对于线上环境打开 vue devtool 查看参数。如何在上线时使用 cdn 在开发环境又默认使用 install
3. 如何判断一个大表单有没有进行修改数据？ 是否弹框提醒

### console

1. 意图配置的 tag 输入框，多 tag 下拉框的位置计算
2. 页面跳转的处理，vuex 存储 next（）
3. 轮询接口的封装
4. requestId 捕捉器
5. vuex 的小封装

#### 搜索高亮

- vue 项目中搜索高亮，通过正则表达式拼接标签高亮，再通过 v-html 显示，能够高亮，但是会带来跨站攻击 ？需要手动过滤 script 标签等
- v-html 你的站点上动态渲染的任意 HTML 可能会非常危险，因为它很容易导致 XSS 攻击。请只对可信内容使用 HTML 插值，绝不要对用户提供的内容插值。
- 你项目中如何进行用户输入过滤的？都过滤了那些内容？(根据回答有了下一个问题)
- 为什么没有过滤<img>标签？

#### 自定义提示保存弹框的处理

有几个不同版本：

##### 不使用 vue-router 使用原生的 confirm 函数

缺点： 难看，不能自定义。

##### 能使用 vue-router

使用 vue-router 的钩子函数，主动赋值 next 函数

##### 不使用 vue-router

1. seajs 中我是如何进行处理的。
2. seajs 中这样处理的问题在哪里？ 最后我是如何进行处理的？

#### 实现自动伸长的 textarea

#### 动态输入框下拉框

场景是一个输入框，输入过程中如果输入了单个 { 符号的话，出现 tag 标签，并且出现下拉框

1. input width 如果设置为 auto 的话跟没有设置是一样的，默认 html5 原生 input 的 width content 是 125 px

2. 需要动态获取输入框中的内容的长度，有几个方案

   1. vue 的 v-model 可以直接获取双向绑定的值，通过 value.length 可以直接获取长度。 一个 input content 的计算方式是 value.length \* font-size 但是有一个问题，数字、英文字体与中文字体的宽度计算方式不一致，也就是说上面的计算方式仅限于中文，如果 value 中包含英文或者数字，width 计算是不准的。
   2. 监听 input 的 input 事件（注意与 change 事件的差别）变动的 dom 节点的获取是 event.target 。 默认情况不指定 input 的 width 的话，输入超出 width 的文本可能乎出现滑动条或者字符往左进行滚动，通过 event.target.scrollWidth 可以直接获取 input 真实的 width 不需要考虑是什么字符

3. 在 vue 中的解决方案

   1. 在 input 监听回调中通过 e.target.style.width = e.target.scrollWidth + "px"; 可以达到我们想要的效果，但是理论上这是在直接操作 dom，在 vue 中也算是比较忌讳的。

   2. 直接通过 vue 的指令来实现 v-autoWidth 加上即可。 input 每次输入都会执行指令的 update 钩子函数，首次挂载的时候执行 bind 钩子函数，首次执行的时候为了初始化 input 的长度。

      ```js
        directives: {
          autoWidth: _debounce(function(el) {
            el.style.width = el.scrollWidth + "px";
          })
        },
      ```

      需要注意的是这里不能够使用限频，因为同一个指令有被多次使用，就会在渲染期间多次触发，限频会被影响。

   3. <http://www.cnblogs.com/cythia/p/5977643.html> 另一种方案。。

   4. 指令中没有 this 指向 vm， 但是如果需要获取 this 的话，vnode.context 就是指向当前的 this 的。

参考：

<https://blog.csdn.net/superit401/article/details/72473318>

<https://blog.csdn.net/young_Emily/article/details/77335158>

```
        // clientWidth = width（可见区域）+ padding - 滚动条宽度
        // offsetWidth = width（可见区域） + padding + border（若有滚动条宽，那就包含在里面了）
        // scrollWidth = width（自身实际长度，包括不可见区） + padding + border + margin
```

#### vue 指令打点上报

1. PV/UV
2. 点击事件 声明式上报 （很多节点注册事件的性能问题， 如何使用代理形式 ？）
3. 主动上报 耦合进业务逻辑

曝光和打点，全部通过指令来完成，尽可能与业务逻辑进行解耦，抽成组件的形式

https://www.cnblogs.com/xumengxuan/p/10682338.html
https://www.cnblogs.com/huiwenhua/p/13368415.html

https://hughfenghen.github.io/fe/vue-directive-track.html#%E4%BC%A0%E7%BB%9F%E5%9F%8B%E7%82%B9-vs-%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%9F%8B%E7%82%B9

上报的几种分类型是：

https://www.cnblogs.com/xumengxuan/p/10682338.html

https://hughfenghen.github.io/fe/vue-directive-track.html#%E5%8F%AF%E5%8F%82%E8%80%83%E7%9A%84%E6%8C%87%E4%BB%A4%E6%BA%90%E7%A0%81

#### 问题点

binding.value 不是响应式的

#### 轮询延迟接口查询

这里很重要的一点是，一个 promise 执行完毕之后，如果没有 resolve 或者 rejected 结果的话，这个 promise 就不会返回任何东西，也就是说 await 或者 then 都获取不到结果。就算在执行期间重新又 new Promise 了，但那是一个新的 Promise，对于之前的 那个 promise 来说，正确的轮询接口返回结果传递的方式应该是将执行期间的 new Promise 的结果由第一个 promise resolve 出去。 就像这里的 `resolve(await sleepHandle(async () => await pollCheck(TaskRequestId)))`, await 的结果是一个有结果， 也就是说，最后 pollCheck 函数能够得到结果。

```js
// 递归轮训函数
export function pollCheck(TaskRequestId) {
  // Vue.prototype.$tip.loading({
  //   msg: 'loading...',
  //   duration: 0
  // })
  return new Promise((resolve, reject) => {
    queryTaskStatus(TaskRequestId).then(async resp => {
      const Status = (resp && resp.Response && resp.Response.Status) || 0;
      if (Status === 0) {
        console.log('pollCheck...');
        // 这里也需要 resolve 一个 promise
        resolve(await sleepHandle(async () => await pollCheck(TaskRequestId)));
      } else {
        console.log('resp', resp);
        resolve(resp);
      }
    });
  });
}
```

#### TODO: 大文件上传

只知道上传的头信息是 application/x-www-form-urlencoded，也可以对上传的文件的数据进行拦截处理，例如对上传文件的信息进行加密处理。

### 在 Vue 中使用 localStorage 的时候， computed 不能够触发 getter 的重新计算，如何解决的。 通过自定义事件

### h5

1. 1px 那个问题，以前是直接通过 dpi 进行缩放，现在的解决是通过媒体查询，进行缩放
2. h5 的输入框、键盘的处理，安卓 ios 等等会有不同的表现

### 企业微信 helper

## cli 开发工具

重点：qcmagic + dev

背景： 平台只提供了 React + ts 的形式，ts 当时不流行，而且组件库适配差，更新频繁。 希望有其他的解决方案。

处理： 如何基于 webpack-dev-server + qcmagic + vue 的组件库来提供一个便于 vue 开发者开发业务的解决方案。 qcmagic 注入了 seajs 提供的模块功能，webpack 配置最终输出的结果是 seajs 支持的 CMD 形式，提供这个链接给到平台注册。

#### qcmagic

将官网平台能力封装成一层粘合层，提供给 vue 开发者。

#### mock router

腾讯云官网的 console, 难点在于不能使用 vue router ,用过 seajs 来做的一层操作，一个比较麻烦的功能是： 用户在页面点击修改之后，退出未保存，自定义弹框提醒用户，而不是使用浏览器自带的提示框(说明有什么坏处)， 在有 vue router 的时候将 next 函数储存起来，点击确定之后再去主动触发。而不能用 router 的时候，seajs 中的 路由跳转其实是 navigate 函数做的，所以给了一个解决方案是，在 路由组件中，点击跳转前会做一次校验，是否没保存，如果是需要提示的页面，手动储存 next 函数(这里是 navigate)，否则直接进行跳转。讲一讲 webpack 的模块加载原理？我理解的 seajs 与 vue 的共生问题。

## Feature Flag 灰度配置中心

一个基于 git 和 node 的轻量化灰度配置工具。 是一个灰度工具。

？？？？背景很重要。！！！

接入流水线，打通企业微信对话机器人。能够理解语义，自动打开配置的开关？

#### 实现原理

koa server + git json 文件 + redis 存库。

基础：

1. koa + auth 中级安全鉴权。
2. 任何权限的改动，都会修改 json 文件（增删改 json 的配置，说白了就是加一行配置）， 提交 mr 到指定的分支上去，触发服务的重新部署。

json 内容示例：

```json
{
  "wxBot": {
    "allow": [
      {
        "rtx": "yiliang",
        "center": "中心 1",
        "info": "xxxx"
      }
    ],
    "refuse": [
      {
        "rtx": "yiliang1",
        "center": "中心 2",
        "info": "xxxx"
      }
    ]
  }
}
```

进阶：

1. 基础功能肯定是通过 rtx 名字去匹配，但是若是对于整个中心的匹配，这样的规则就很不灵活。所以中间加了一层对于中心的匹配。定时任务拉取中心的所有人名单，存入数据库中，待查询。
2. 打通企业微信机器人， 通过 @ 机器人回答问题，即可调用 git 的 api 指定文件中，添加一行配置， 并自动发起一个 pr，会自动 @ 管理员通过 pr 即可自动发布服务。

#### 可复用 灰度

页面灰度

用户级别 （id ），模块（功能）级别

通过 js api 传一个 key 去拿到配置文件，与客户端和后台公用，可见不可见。
