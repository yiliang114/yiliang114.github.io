---
title: 数据平台中心
date: 2020-11-21
draft: true
---

## 思考

1. low code 项目的价值在哪里？ 提升了多少效率

## 数据平台中心

所在的数据平台中心有两个主要的产品：

1. 企业罗盘，定位是专注 tob 的一站式数据工作平台。 有三大核心功能（报表、仪表盘、图表）用于日常的数据分析，分享和汇报。
2. 移动端数据应用工厂，一种对收入数据多场景、多维度的可视化数据汇报看板的解决方案。（这是我主要负责的项目）

### 项目简介

数据工具：

1. 小程序
2. 仪表盘
3. 数据资产

前端库包：

1. cdata-cli
2. cdata-utils
3. material
4. t1
5. cdata-bot
6. cdata-plugin

组件库：

1. vue 组件库， pc + mobile

### 企业罗盘背景

平台项目简介：

1. 维表： 简单理解为是一个 key value 配置库工具
2. 报表：
3. 工作表：在线
4. 仪表盘 PC/Mobile
5. 数据应用工厂
   1. 驾驶舱
   2. 行业经分
   3. 产品分析
   4. 客户分析
   5. 销售看板
   6. 月度经营分析等。。

### Low Code 数据工厂

TODO: 以 STAR 法介绍这个项目。

可配置化的前端项目

1. json 中无法写函数，写的函数无法很好的注入 content 或者 this 之类的上下文，除非改造函数的写法，比如 vm => vm.data 之类的将 this 传入
   解决： 参考 vscode 中的 ui 可配置化，采用 when 的形式，对操作符进行处理，将 when 字符串拼接上 with(this) 执行的接口会被自动 return， 这样就可以直接写属性名的判断条件，而不用带上 this 之类的前缀

2. 随着项目的更新，旧的配置解析器慢慢显示出一些问题（项目初期设计不算太完善），但是线上已经有多个项目在跑了，新功能要加入旧解析器不能再很好的工作了。
   解决： 优雅降级，对于老的组件，额外开发一些 transfor 转换器，将新配置（可读性更好）的配置转化成旧配置进行渲染； 对于新组件，直接将新的配置文件进行解析渲染。

1) 可视化组件库的规范？？？

搭建系统 https://github.com/MrXujiang/h5-Dooring

手写 json 配置。

#### 技术点

- vue
- 可视化
- echart
- 通过 json 配置文件生成目录结构
- 小程序 + webview

#### 搭建系统背景

1. 平台整个工作链路
2. 介绍高管驾驶舱

#### 角色与权限

前端对于角色的权限解决有两种方案：

1. router 全量注册，通过 beforeEnter 钩子前端来判断当前角色是否有权限进入该页面
2. 默认只注册不设权限的页面，通过 auth 接口拿到有权限的列表，通过 filter 全量的配置文件内容，addRoutes 动态注册有权限的路由。

后者比前者好的点：权限问题后台也需要拉取，前者需要两边都拉取，用映射关系各自做权限判断处理，一来两边都计算会不统一，修改权限需要改两处，二来权限 map 全量返回前端或者前端直接写死有泄漏风险。

后者缺点：需要额外做一次配置的筛选操作，返回给前端处理。

#### 为什么要做一个移动端的数据应用？

1. pc 仪表盘迭代速度跟不上，图表组件库不够丰富。
2. pc 仪表盘的业务逻辑很重，系统优化历史包袱重，充满了不同环境、入口的兼容性代码，大量的 if else 判断环境。 针对汇报看板这个场景，希望有一个轻量、高性能的应用让 leader/GM 有更好的体验。
3. 数据应用对数据的权限控制颗粒度更细，需要更加灵活的支持多种角色的权限管控，所以更适合站在巨人的肩膀上另起炉灶。

#### 怎么做的？

**TODO: 重点原理**

- 前端： 基于 vue JSX + 自定义的 JSON Schema 规范。分为 ui 和 dataOptions 属性，分别对应 ui 和取数逻辑。
  - 组件库的处理。 vant + echarts + table + 自定义的图表组件。
- Node: 基于 SQL 语法定义的自定义 JSON Schema 搜索语句。
  - worksheetId 数据源
  - Filters 筛选
  - Configs 小计
  - Variables 条件配置

**步骤**

1. 首先定义了一个渲染的基类组件 comp， 注册了很多 components， 并传入 is 表示组件名，dataSource 用于渲染组件内容的数据。
2. 定义最小模块 module，它拥有 beforeLoad, loaded, Error 几个钩子函数。 需要传入 ui 和 dataOptions 两个属性
3. 多个 module 可以组成一个 modules， 就可以直接拼装成一个页面。默认情况下，modules 不会自动发出请求，因为不会给它传 dataOptions，但是实际上 modules 是从 module， 它也拥有单独取数的能力。
4. 组件的几种分类：
   1. 数据渲染组件，例如 table， line，条形图、柱状图等，在封装了一层 echarts 的情况下， 这些组件都是直接在 comp 组件中注册的，意味着只要给 comp 传 is 和 dataSource 就可以正常渲染。
   2. 筛选的功能组件，这种组件 change 之后会改变取数的条件，用于更新数据。 这里就需要考虑如何与事件消费中心打通，

##### renderChild

一个主 Vue 实例渲染所有组件的形式。

问题：

1. 最大的问题之一， bff 层的对接，不是直连后台服务。解决方式： 手动填入数据，或者接口
2. 组件生态不够好，设计师设计稿很好看，前期组件沉淀还不够，不能够迅速搭建起移动端页面。
3. 传统的可视化搭建系统存在的最大问题是，基本上都是单个页面的，比如活动页，表单收集页等，因为路由切换、多页数据共享等逻辑会与传统可搭建系统的纯粹性产生冲突，当然也不排除一些业务本身的场景比较简单。从编译的角度上来做的 搭建系统就可以解决这个问题，所谓的搭建，其实就是在写 dom json 。

#### 与其他业界的 low code 项目的区别在哪里？

#### 难点

##### 数据通信

主要的难点是在于数据通信：

1. 一个页面多个图表，用同一个数据源（需要减少请求）
2. 多个页面共享一个筛选条件
3. 同一个页面有多个触发条件取数的操作
4. 每个月固定日期出数：
   1. 到时间，人工打开配置开关
   2. 定时任务修改配置文件，通过企业微信机器人对话即可自动修改配置（最主要的目的是控制出数的人不需要上配置平台，减少操作心智）

TODO:数据通信的解决方案：

1. 直接写 vuex 肯定不够灵活。考虑动态加载模块 ？
2. vue bus 自定义事件的形式更好用。

##### 取数事件触发

1. 日、周、月切换；时间选择
2. 维度切换

等条件切换之后都有可能会重新触发取数。 但是如果每一个事件触发都直接发一个请求的话，会有几个问题：

1. 首先肯定是浪费资源
2. 其次因为筛选的条件不一致，如果前一个请求没有及时退出，可能会因为底层数据的多少差别，而导致图表数据闪烁（多个请求返回）

解决：

1. 封装 axios 的时候，需要根据取数 ID 来存储 axios 的 token, 如果多个请求发出，需要再下一个请求发出之前先调用 token.cancel 函数退出请求
2. 设计一个简洁的事件消费中心对象，每一个取数模块需要预先注册取数的触发事件名，条件组件触发之后，消费中心接收到事件比对触发事件名，若匹配则发出请求。

#### 成果

经过该数据应用工厂底座能力创建的数据应用已经有 5 款，上线速度快，效果体验好。

#### 搭建系统的优点和不足

亮点：

1. mock 平台，做了数据权限管控和模拟用户的功能，能够让定时任务很好每天定时跑，一来预加载缓存，二来作为一个接口的自动化测试
2. 节省了很多的人力

不足：

1. 实时 SQL，加入的缓存是对参数 md5 之后的缓存，直接而强硬。

优点：

1. 开发时间更快，数仓、后台、前端三个方向的开发工作量都更小了。

#### Iframe 自适应高度

- 同域
- 跨域

##### postMessage

1. 子 iframe 页面只能调用 top.postMessage. 不能调用 parent.postMessage 的原因 ？
2. 父页面往子 iframe 发送事件，可以拿 iframe 的 dom 节点的 contentWindow 调用 postMessage 事件。但是父页面不知道子页面什么时候加载完毕，只能退而求其次，先让子 iframe 发送事件给父页面之后，通过 event.source 调用 postMessage 节点发送消息。 虽然实际上是同一个引用。

### TODO: 权限组件的设计 ？

为了缓存，带权限接口与非权限接口有可能需要剥离

### Mock 怎么支持
