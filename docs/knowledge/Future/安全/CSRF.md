---
layout: CustomPages
title: safety
date: 2020-11-21
aside: false
draft: true
---

# CSRF 跨站请求伪造 Cross Site Request Forge

打开同一浏览器时其他的网站对本网站造成的影响。原理就是攻击者构造出一个后端请求地址，诱导用户点击或者通过某些途径自动发起请求。如果用户是在登录状态下的话，后端就以为是用户在操作，从而进行相应的逻辑。
![原理](https://wire.cdn-go.cn/wire-cdn/b23befc0/blog/images/csrf.png)

举个例子，用户同时打开了 A 网站和钓鱼网站。 假设 A 网站中有一个通过 GET 请求提交用户评论的接口，那么攻击者就可以在钓鱼网站中加入一个图片，图片的地址就是评论接口。

```html
<img src="http://www.domain.com/xxx?comment='attack'" />
```

## CSRF 攻击原理

1. 用户登录 A 网站
2. A 网站确认身份（给客户端 cookie）
3. B 网站页面向 A 网站发起请求（带上 A 网站身份）

![](http://img.smyhvae.com/20180307_1735.png)

> 用户是网站 A 的注册用户，且登录进去，于是网站 A 就给用户下发`cookie`。

> 从上图可以看出，要完成一次`CSRF`攻击，受害者必须满足两个必要的条件：

1. 登录受信任网站`A`，并在本地生成`Cookie`。（如果用户没有登录网站`A`，那么网站`B`在诱导的时候，请求网站`A`的`api`接口时，会提示你登录）
2. 在不登出`A`的情况下，访问危险网站`B`（其实是利用了网站`A`的漏洞）。

> 我们在讲`CSRF`时，一定要把上面的两点说清楚。

> 温馨提示一下，`cookie`保证了用户可以处于登录状态，但网站`B`其实拿不到 `cookie`。

> 举个例子，前段时间里，微博网站有个`api`接口有漏洞，导致很多用户的粉丝暴增。

## CSRF 防御

**方法一、Token 验证：**（用的最多）

1. 服务器发送给客户端一个`token`；
2. 客户端提交的表单中带着这个`token`。
3. 如果这个 `token` 不合法，那么服务器拒绝这个请求。

**方法二：隐藏令牌：**

- 把 `token` 隐藏在 `http` 的 `head`头中。

> 方法二和方法一有点像，本质上没有太大区别，只是使用方式上有区别。

**方法三、Referer 验证：**

> `Referer` 指的是页面请求来源。意思是，**只接受本站的请求，服务器才做响应**；如果不是，就拦截。

1. Get 请求不对数据进行修改
2. 不让第三方网站访问到用户 Cookie
3. 阻止第三方网站请求接口
4. 请求时附带验证信息，比如验证码或者 Token
5. 验证码： 用户每次提交都需要在表单中填写图片上一个随机的字符串
6. 添加一个隐藏的输入框，包含 token，服务端验证是否匹配
7. 使用 http refer 头部进行判断，如果不是业务域名发起的 http 请求直接过滤。

- SameSite
  - 可以对 Cookie 设置 SameSite 属性。该属性表示 Cookie 不随着跨域请求发送，可以很大程度减少 CSRF 的攻击，但是该属性目前并不是所有浏览器都兼容。
- Token 验证
  - cookie 是发送时自动带上的，而不会主动带上 Token，所以在每次发送时主动发送 Token
- Referer 验证
  - 对于需要防范 CSRF 的请求，我们可以通过验证 Referer 来判断该请求是否为第三方网站发起的。
- 隐藏令牌
  - 主动在 HTTP 头部中添加令牌信息

禁止第三方网站带 cookies

[same-site](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies#SameSite_Cookies)属性。 设置只有同一站点的请求才能携带 cookie

## CSRF 蠕虫

如果某个用户打开了被攻击网页，并且用户同时访问了攻击者的网页。
那么攻击者的网页就会使用用户的身份发送一些请求，并且常用用户的身份发布一些评论或文章，里面包含攻击者的网页链接。如果其他用户看到了这个用户的这条评论，都甚至可以不点击，其他用户也会被盗用身份发送一些恶意请求。这样病毒的传播就会越来越快，影响越来越大。

## CSRF 攻击危害

- 利用用户登录态
- 用户不知情
- 完成业务请求
- 盗取用户资金
- 冒充用户发帖背锅
- 损坏网站名誉

### 网页验证码是干嘛的，是为了解决什么安全问题

区分用户是计算机还是人的公共全自动程序。可以防止恶意破解密码、刷票、论坛灌水；
有效防止黑客对某一个特定注册用户用特定程序暴力破解方式进行不断的登陆尝试。

### CSRF

什么是 CSRF 攻击？如何防范 CSRF 攻击？

CSRF 中文名为跨站请求伪造。原理就是攻击者构造出一个后端请求地址，诱导用户点击或者通过某些途径自动发起请求。如果用户是在登录状态下的话，后端就以为是用户在操作，从而进行相应的逻辑。

举个例子，假设网站中有一个通过 `GET` 请求提交用户评论的接口，那么攻击者就可以在钓鱼网站中加入一个图片，图片的地址就是评论接口

```
<img src="http://www.domain.com/xxx?comment='attack'"/>
```

那么你是否会想到使用 `POST` 方式提交请求是不是就没有这个问题了呢？其实并不是，使用这种方式也不是百分百安全的，攻击者同样可以诱导用户进入某个页面，在页面中通过表单提交 `POST` 请求。

#### 如何防御

防范 CSRF 攻击可以遵循以下几种规则：

1. Get 请求不对数据进行修改
2. 不让第三方网站访问到用户 Cookie
3. 阻止第三方网站请求接口
4. 请求时附带验证信息，比如验证码或者 Token

##### SameSite

可以对 Cookie 设置 `SameSite` 属性。该属性表示 Cookie 不随着跨域请求发送，可以很大程度减少 CSRF 的攻击，但是该属性目前并不是所有浏览器都兼容。

##### 验证 Referer

对于需要防范 CSRF 的请求，我们可以通过验证 Referer 来判断该请求是否为第三方网站发起的。

##### Token

服务器下发一个随机 Token，每次发起请求时将 Token 携带上，服务器验证 Token 是否有效。

### CSRF

> **跨站请求伪造**（英语：Cross-site request forgery），也被称为 **one-click attack** 或者 **session riding**，通常缩写为 **CSRF** 或者 **XSRF**， 是一种挟制用户在当前已登录的 Web 应用程序上执行非本意的操作的攻击方法。[[1\]](https://www.wikiwand.com/zh/%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0#citenoteRistic1) 跟[跨網站指令碼](https://www.wikiwand.com/zh/%E8%B7%A8%E7%B6%B2%E7%AB%99%E6%8C%87%E4%BB%A4%E7%A2%BC)（XSS）相比，**XSS** 利用的是用户对指定网站的信任，CSRF 利用的是网站对用户网页浏览器的信任。

简单点说，CSRF 就是利用用户的登录态发起恶意请求。

#### 如何攻击

假设网站中有一个通过 Get 请求提交用户评论的接口，那么攻击者就可以在钓鱼网站中加入一个图片，图片的地址就是评论接口

```html
<img src="http://www.domain.com/xxx?comment='attack'" />
```

如果接口是 Post 提交的，就相对麻烦点，需要用表单来提交接口

```html
<form action="http://www.domain.com/xxx" id="CSRF" method="post">
  <input name="comment" value="attack" type="hidden" />
</form>
```

#### 如何防御

防范 CSRF 可以遵循以下几种规则：

1. Get 请求不对数据进行修改
2. 不让第三方网站访问到用户 Cookie
3. 阻止第三方网站请求接口
4. 请求时附带验证信息，比如验证码或者 token

##### SameSite

可以对 Cookie 设置 `SameSite` 属性。该属性设置 Cookie 不随着跨域请求发送，该属性可以很大程度减少 CSRF 的攻击，但是该属性目前并不是所有浏览器都兼容。

##### 验证 Referer

对于需要防范 CSRF 的请求，我们可以通过验证 Referer 来判断该请求是否为第三方网站发起的。

##### Token

服务器下发一个随机 Token（算法不能复杂），每次发起请求时将 Token 携带上，服务器验证 Token 是否有效。

## CSRF 和 XSS 的区别

> 面试官还可能喜欢问二者的区别。

**区别一：**

- `CSRF`：需要用户先登录网站`A`，获取 `cookie`
- `XSS`：不需要登录。

**区别二：（原理的区别）**

- `CSRF`：是利用网站`A`本身的漏洞，去请求网站`A`的`api`。
- `XSS`：是向网站 `A` 注入 `JS`代码，然后执行 `JS` 里的代码，篡改网站`A`的内容。

`XSS`是获取信息，不需要提前知道其他用户页面的代码和数据包。`CSRF`是代替用户完成指定的动作，需要知道其他用户页面的代码和数据包。

要完成一次`CSRF`攻击，受害者必须依次完成两个步骤：

```
登录受信任网站A，并在本地生成Cookie。

在不登出A的情况下，访问危险网站B。
```

### XSS 是什么，攻击原理，怎么预防

#### XSS 是什么

XSS 是一种跨站脚本攻击，是属于代码注入的一种，攻击者通过将代码注入网页中，其他用户看到会受到影响(代码内容有请求外部服务器);

#### xss 攻击分类：

- 反射型：攻击者构造一个带有恶意代码的 url 链接诱导正常用户点击，服务器接收到这个 url 对应的请求读取出其中的参数然后没有做过滤就拼接到 Html 页面发送给浏览器，浏览器解析执行
- 存储型： 攻击者将带有恶意代码的内容发送给服务器（比如在论坛上发帖），服务器没有做过滤就将内容存储到数据库中，下次再请求这个页面的时候服务器从数据库中读取出相关的内容拼接到 html 上，浏览器收到之后解析执行
- dom 型：dom 型 xss 主要和前端 js 有关，是前端 js 获取到用户的输入没有进行过滤然后拼接到 html 中

#### 扩展

CSRF 是一种跨站请求伪造，冒充用户发起请求，完成一些违背用户请求的行为(删帖，改密码，发邮件，发帖等)

#### 防御方法举例:

- 使用 encodeURIComponent 对 url 中的参数进行编码(反射型 xss)，对一些关键字和特殊字符进行过滤(<>,?,script 等)，或对用户输入内容进行 URL 编码(encodeURIComponent);
- Cookie 不要存放用户名和密码，对 cookie 信息进行 MD5 等算法散列存放，必要时可以将 IP 和 cookie 绑定;
- 对用户的输入进行过滤(适用于所有类型的 xss 攻击)
- 对用户的输入使用 innerText 或者 textContent 进行设置，而不是使用 innerHTML 或者 outerHTML 进行设置
- 服务器端设置 cookie 为 httpOnly 让前端无法通过 js 获取到用户的 cookie
- 关键请求使用验证码，比如转账请求，避免恶意脚本发送这些关键请求

### 常见 web 安全及防护原理

sql 注入原理

就是通过把 SQL 命令插入到 Web 表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的 SQL 命令
总的来说有以下几点

永远不要信任用户的输入，要对用户的输入进行校验，可以通过正则表达式，或限制长度，对单引号和双”-“进行转换等
永远不要使用动态拼装 SQL，可以使用参数化的 SQL 或者直接使用存储过程进行数据查询存取
永远不要使用管理员权限的数据库连接，为每个应用使用单独的权限有限的数据库连接
不要把机密信息明文存放，请加密或者 hash 掉密码和敏感的信息
XSS 原理及防范

Xss(cross-site scripting)攻击指的是攻击者往 Web 页面里插入恶意 html 标签或者 javascript 代码。比如：攻击者在论坛中放一个看似安全的链接，骗取用户点击后，窃取 cookie 中的用户私密信息；或者攻击者在论坛中加一个恶意表单，当用户提交表单的时候，却把信息传送到攻击者的服务器中，而不是用户原本以为的信任站点
XSS 防范方法

首先代码里对用户输入的地方和变量都需要仔细检查长度和对”<”,”>”,”;”,”’”等字符做过滤；其次任何内容写到页面之前都必须加以 encode，避免不小心把 html tag 弄出来。这一个层面做好，至少可以堵住超过一半的 XSS 攻击
XSS 与 CSRF 有什么区别吗？

XSS 是获取信息，不需要提前知道其他用户页面的代码和数据包。CSRF 是代替用户完成指定的动作，需要知道其他用户页面的代码和数据包。要完成一次 CSRF 攻击，受害者必须依次完成两个步骤

登录受信任网站 A，并在本地生成 Cookie

在不登出 A 的情况下，访问危险网站 B

CSRF 的防御

服务端的 CSRF 方式方法很多样，但总的思想都是一致的，就是在客户端页面增加伪随机数
通过验证码的方法

### DNS 解析过程,DNS 解析会出错吗，为什么

https://blog.csdn.net/yipiankongbai/article/details/25031461

### 如何应对流量劫持

#### 流量劫持

利用各种恶意软件修改浏览器、锁定主页或不停弹出新窗口，强制用户访问某些网站，从而造成用户流量损失的情形。流量劫持是一种古老的攻击方式，比如早已见惯的广告弹窗(如下图)等，很多人已经对此麻木，并认为流量劫持不会造成什么损失。而事实上，流量劫持可以通过多种你无法觉察的方式窃取信息!
流量劫持的方式有很多种，常见的主要有 DNS 劫持、CDN 入侵、网关劫持、ARP 攻击、Hub 嗅探等等

##### 劫持实现的手段

域名劫持：通过劫持掉域名的 DNS 解析结果，将 HTTP 请求劫持到特定 IP 上，使得客户端和攻击者的服务器建立 TCP 连接，而不是和目标服务器直接连接，这样攻击者可以对内容进行窃取或篡改。在极端的情况下甚至攻击者可能伪造目标网站页面进行钓鱼攻击。

直接流量修改：在数据通路上对页面进行固定的内容插入，比如广告弹窗等。在这种情况下，虽然客户端和服务器是直接建立的连接，但是数据内容依然可能遭到野蛮破坏

#### 阻止劫持手段

##### 限制网站权限

部分网站遭遇劫持主要由于非法服务器获取了 Web 网站文件及文件夹的读写权限，针对这个问题，我们可以利用服务器的安全设置、提高网站程序的安全性，以此防范 Web 劫持。

##### 提升网站 防 SQL 注入功能

SQL 注入通过利用 SQL 语言的特性，向 Web 数据库写入内容，获取权限，因此我们需要针对 MS SQL Server 数据库中的小权限 sa 默认用户，建立一个只能访问本系统数据库的专一用户，并且为他配置最小权限。

##### 配置 Web 站点文件夹及其操作权限

使用 Windows 系统中的超级管理员权限对 Web 站点文件和文件夹进行权限配置。将大部分人的权限配置为仅读权限，黑客在没有写权限的情况下，很难将木马程序植入，减少网站域名劫持的可能性。

##### 定期清理 Web 网点中存在的可疑文件

不管黑客通过何种方式获取权限，在事件管理器中都会显示出异常情况，通过对异常事件和日期的分析，查看执行代码文件中是否被人注入代码或改动，并且对新增可执行代码进行清理。

##### 使用公共 114DNS

让用户绕过运营商 local DNS，使用 114 DNS（国内最大的中立缓存 DNS），这种在技术实现上有比较大的难度，成本也比较高。在现在的情况下即使用户使用公共 DNS，也并不能完全解决问题。先不论公共 DNS 是否也有在做劫持，最关键的是，运营商也会专门针对到公共 DNS 的流量做劫持。对于流量入口的把控，运营商不会放松警惕。

##### HttpDNS，防止 DNS 劫持

在移动客户端中加入一个域名解析模块，客户端通过 HTTP 的方式向网站的流量调度服务器请求 IP，流量调度服务器会根据用户所在位置给用户一个最优的 IP。客户端在获取 IP 后直接用此 IP 来访问所需站点资源
![image](https://user-images.githubusercontent.com/21194931/56857931-8695df00-69a5-11e9-801c-b69bc660ecc8.png)

##### HTTPS 防劫持

由于公共 DNS、HttpDNS 的部署成本过高，有一定的技术难度，并且在面对无孔不入的 DNS 劫持时难免会力有不逮。这时候网站开启 HTTPS 作为防流量劫持手段之一可以高效的解决这些问题。目前绝大部分网站也都已经启用 HTTPS 来加密。HTTPS 协议就是 HTTP+SSL/TLS，在 HTTP 的基础上加入 SSL /TLS 层，提供了内容加密、身份认证和数据完整性三大功能，最终目的就是为了加密数据，用于安全的数据传输
![image](https://user-images.githubusercontent.com/21194931/56857932-8dbced00-69a5-11e9-8e8a-5c0f1d0ad3b9.png)
![image](https://user-images.githubusercontent.com/21194931/56857935-91507400-69a5-11e9-9125-c3cf0108bdc8.png)

##### 如何快速启用 HTTPS

鉴于启用 HTTPS 会带来一定的服务器资源消耗，目前大多数公司普遍的选择是直接使用国内的 CDN 服务，比如又拍云提供一站式 HTTPS 服务，简单几步就能完成全站 HTTPS 的部署，光是免费类证书就有 2 款，而付费证书在 3-5 天内即可完成申购。另外一种可以直接在 Web 服务器上部署证书和私钥，可以去网上查看教程。

#### 总结

面对 Web 流量劫持，首先我们可以在网站层面限制读写权限，限制恶意代码的写入，其次可以通过公有 DNS 和 HttpDNS 来防止恶意 DNS 劫持。全站开启 HTTPS，加密数据传输，可以有效防止数据泄漏，同时解决流量劫持的问题

### 接口如何设计才能限频，同时保证安全？

post 改 get 请求，只取需要的字段，多余的设置， sql 代码中进行拼接的时候判断一下是否会 sql 注入，最好的防止 xss 的方法有两个：

- 最好不适用 vue 的 v-html
- 与后台接口的交互 encode 转化一下，多几个步骤

* 为什么在不把 token 存放在 cookie 中 csrf ？ 放在 http 请求头中需要做什么额外的工作(resp 头？)
