---
title: 遇到的问题
date: 2020-11-21
aside: false
draft: true
---

## 遇到的问题

### 功能类

#### 驾驶舱的顶部 Tab 渲染同 ID 的 Item 的顺序错乱现象

对于一个 Tab 组件，传入的一个元素是 Tab 对象的数组，渲染一个 Tabs 列表。 数据举例如下：

```js
const A = [0, 1, 2, 3];

const B = [0, 1, 2];
```

对于 A B 两个数组， 最后一个元素的 Id 相等，前面的 Id 都不同。在切换 Tabs 的过程中，就是替换 A B 数组的值。但是每次切换的过程中，最后一个 Tab 位置总是会跑到第一位（首次渲染的位置相同。）， 后来想了一下这个原因是因为 Vue 在增加删除节点的时候，相同的 Key 的元素，就当做旧元素，已经消失的 Key 元素，节点会被删除；而原本不存在的节点，会被作为新 Key 插入到后面。 这就是为什么，最后一个 Tab 元素在切换过程中跑到最前面去的原因，这里只要改一下，用不同的 Key 值即可。

#### 页面跳转之前的请求没有结束，会被 cancel

https://segmentfault.com/a/1190000013132078

日志上报的失败率比较高，很多都是直接被 cancel (abort) 调的。

使用 `navigator.sendBeacon` 打点上报有一个好处， 对于页面直接跳转的情况，也能上报数据，而不会被 cancel。 所以 navigator.sendBeacon 的部分，其实并不需要 await 它，正常写同步的顺序就好。

#### 正则匹配中文出错

背景：如何使用正则判断字符串中是否全部是中文？
通过百度或者 google 之后得到的答案一般都是：

```
const reg = /^[\u4e00-\u9fa5]*$/
reg.test('中文')
```

但是实际上遇到了一个中文 "䃼" 的时候，正则就返回了错误。 一开始没有意识到这是一个不常见的中文，或者换句话说没有意识到不常见的中文没有落在上面的正则表达式里。在线中文转化 unicode 之后得到这个字的 unicode 编码是 "\u40fc", 看起来确实没有落在上面正则的范围里。补上一般完整的中文编码符号。https://blog.bvcode.com/res/159/

### 性能优化类

#### 前端安全问题

CSRF ？？？

g_tk 算法

https://www.cnblogs.com/a849788087/p/6440264.html

### 白屏问题排查

https://www.cnblogs.com/thinkingthigh/p/11057079.html

/authorize 白屏页

npm 包的扩展运算符。 不能在 ios 12.1 14.4 上跑起来。

### 小程序问题

#### 小程序内嵌 web-view 的 crash 问题

主要原因是上面的 table 性能问题。

#### 移动网关的自定义域名映射

处理之前，需要给前端项目打两份包出来，动态插入网关 key 到 baseUrl 中去， 发布两份 dist 静态资源。

通过申请一个自定义域名，与指定的 key 建立绑定关系，那前端在打包脚本上就不需要做额外的处理，baseUrl 也不需要做特殊处理，只打包一份前端代码。缺点： 微信公众号授权域名只支持添加 2 个域名，所以对于测试环境、预发环境、正式环境 有强烈 3 个环境需求的项目，这种方式就不适合。我们的项目是建立在小程序上的，开发环境只能开发者进行访问，所以可以用一个测试域名，本地开发者工具忽略域名的检查，线上的授权域名使用预发环境 和 正式环境两个域名即可。

#### 移动端偶现耗时极长的问题

1. 小程序 h5 授权问题，只能绑定两个域名，所以只能绑定一个预发环境域名，正式环境域名。 测试环境域名只能在本地的开发版小程序使用，本地开发工具忽略域名检查。
2. 公司所有内网资源外部访问，都需要经过移动网关（pc 端经过智能网关）做鉴权，登录态每天失效一次，会自动进行登录。域名是 `xxx.m.yyyy.com` 但是小程序上需要绑定一个 request 域名，公司内部很多小程序已经绑定了这个域名，所以没有办法再直接绑定上了，想了个办法就只能新申请了一个域名 cname 到这个域名上。（通过路径转发 ？ 可能也可以实现，再想一想）
3. 经过移动网关之后，访问内网环境的服务器，请求静态资源和接口。 接口会经过机器上的 nginx 负载均衡转发到 stke 上。 stke 是用来部署后台服务的 docker 平台。
4. 问题： 小程序中网页打开发现 loading 时间过长，偶现。 前端通过在 ajax 请求之前已经接口返回之后上报接口耗时，发现长达 30s - 1min 。 移动网关处排查也发现耗时有那么久，但是 node 日志中间件打印耗时不到 1 秒。
5. 解决：
   1. nginx 默认打印的日志不会添加耗时字段，添加字段。
   2. 移动端 whistle 代理，观察每一个请求的状态，因为直接观察 nginx 日志不好观察。
   3. whistle 上的耗时显示即为前端的体验耗时。查看 nginx 上日志打印的耗时。发现也是 30 多秒。
   4. stke 上能够查看到请求到达和返回的时间节点，差值是业务计算出的耗时，这个值是正常的。
   5. dns cname 耗时排查，gslb 上，询问运维，以及 performance 上应该也能查看。
   6. 移动网关处也是 30 多秒。
   7. 所以推断是 请求到 stke 上的时间有问题 ？
   8. 最终排查到是 访问链路是 vip--》clb 后端--〉TKE 集群 --》业务 pod

微信公众号 or 小程序 webview 内嵌 h5 授权的流程： https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html

#### 身份权限处理

后台路由权限，通过角色映射。前端也动态插入路由，差不多相同的逻辑， 用一个 npm 模块进行处理，保证结果的统一。 使用 lerna ？

#### 移动端 ant d vue table 性能问题

出现的原因： 数据量大，滑动，大量的插槽
解决办法：阅读源码，提取一个单独的 table 移动端高性能组件。

https://www.zhihu.com/question/319837974
https://zhuanlan.zhihu.com/p/102037418

##### 在对 IE 的兼容性方面做了一些取舍，原因是什么？兼容 IE 的难点都有哪些？

微信小程序 web-view 内存溢出

v3 版本为了兼容旧版 IE，不得不做一些妥协。比如说 flex 布局不能用，我们就用 float 和 table 来搞；不能用 sticky，Table 为了实现固定列不得不额外再渲染一个 Table 达到固定列的效果。最近几年，随着 windows 系统的升级，旧版 IE 的占比已经越来越小。这也是一个契机，让我们在 v4 版本可以舍弃过于陈旧的 IE 版本，从而轻装上阵。

兼容 IE 的难点在于很多行为是非预期的，往往代码没有什么问题，但是页面渲染就是不正常。对于这种情况，就需要做不少的黑科技。比如说让组件强制刷新、使用 IE only 的 css hack 等等。此外前面提到的很多 HTML 新特性在 IE 环境下无法使用，只能自行模拟导致严重的性能损耗。

#### 影响

顶部固定，左侧从栏，都是用一个单独的 table 拼接出来的，所以导致它在 ios 在滑动的时候 会有阻尼效果, overflow-x: auto 一定程度上会出现两块 table 脱离的状况。

##### 解决办法

诉求： 手机端的 table： 固定表头 + 左侧栏
sticky 固定，长列表用用虚拟列表。 table 的渲染性能比 div 慢，也可以直接用 div 来模拟。

#### 小程序中打开页面缓存导致无法重定向的问题

302 301 会重定向页面，到（自动）登录的页面，登录之后再重定向会原链接，此时已经戴上了登录态。正常状态是这样。

但是在小程序中静态文件会被缓存起来，每次打开小程序、打开小程序中的 webview 不一定会重定向成功。 是因为跨域了 ？https://www.cnblogs.com/wxlevel/p/7833595.html
https://blog.csdn.net/liyantianmin/article/details/73485545
https://harttle.land/2016/12/30/cors-redirect.html#header-2

**如何进行排查的**：

1. 每天的首次进入耗时会比较大
2. 小程序可能会缓存 index.html 一开始 ci 的发布不是增量发布的。后续修改为增量发布
3. 偶现接口耗时巨大，但是业务部分的中间件耗时统计显示并不高，排查问题，可能是打点节点跟业务接口同域名导致 ？需要测试一下。打点接口不需要过移动网关

#### 移动端

1. 分：多个移动端 h5 页面，业务分开，独立开发部署，业务逻辑不会互相影响，复用度不够，重复开发。
2. 合：新技术栈 vue 引入，组件库，拖拽、可视化搭建开始，建立 schema 规范，模块化渲染。时间和人力，可视化搭建部分暂缓。重用逻辑增多。
3. 分：多个业务模块分开，抽离组件库、渲染器
4. 合：可视化搭建的形态， 重复模块搭建 + 微前端形式。
